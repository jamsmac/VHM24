{
  "dashboard": {
    "id": null,
    "uid": "vendhub-infrastructure",
    "title": "VendHub Manager - Infrastructure",
    "description": "System infrastructure monitoring - containers, hosts, databases, and storage",
    "tags": ["vendhub", "infrastructure", "system"],
    "timezone": "Asia/Tashkent",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "30s",
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "annotations": {
      "list": []
    },
    "templating": {
      "list": []
    },
    "panels": [
      {
        "id": 100,
        "title": "Service Health",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
        "collapsed": false
      },
      {
        "id": 1,
        "title": "Service Status",
        "type": "stat",
        "gridPos": { "h": 6, "w": 24, "x": 0, "y": 1 },
        "targets": [
          { "expr": "up{job=~\"vendhub-backend.*\"}", "legendFormat": "Backend API" },
          { "expr": "up{job=\"postgres\"}", "legendFormat": "PostgreSQL" },
          { "expr": "up{job=\"redis\"}", "legendFormat": "Redis" },
          { "expr": "up{job=\"minio\"}", "legendFormat": "MinIO" },
          { "expr": "up{job=\"commission-worker\"}", "legendFormat": "Commission Worker" },
          { "expr": "up{job=\"job-scheduler\"}", "legendFormat": "Job Scheduler" },
          { "expr": "up{job=\"health-monitor\"}", "legendFormat": "Health Monitor" },
          { "expr": "up{job=\"nginx\"}", "legendFormat": "Nginx" }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "justifyMode": "center",
          "orientation": "horizontal"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "red", "value": null },
                { "color": "green", "value": 1 }
              ]
            },
            "mappings": [
              { "type": "value", "options": { "0": { "text": "DOWN", "color": "red" }, "1": { "text": "UP", "color": "green" } } }
            ]
          }
        }
      },
      {
        "id": 101,
        "title": "PostgreSQL Metrics",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 7 },
        "collapsed": false
      },
      {
        "id": 10,
        "title": "Database Connections",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 6, "x": 0, "y": 8 },
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"vendhub\"}",
            "legendFormat": "Active"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 50 },
                { "color": "red", "value": 80 }
              ]
            },
            "min": 0,
            "max": 100,
            "displayName": "Connections"
          }
        }
      },
      {
        "id": 11,
        "title": "Database Size",
        "type": "stat",
        "gridPos": { "h": 6, "w": 6, "x": 6, "y": 8 },
        "targets": [
          {
            "expr": "pg_database_size_bytes{datname=\"vendhub\"} / 1024 / 1024 / 1024",
            "legendFormat": "Size"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 10 },
                { "color": "red", "value": 50 }
              ]
            },
            "unit": "decgbytes",
            "displayName": "DB Size"
          }
        }
      },
      {
        "id": 12,
        "title": "Database Connection History",
        "type": "timeseries",
        "gridPos": { "h": 6, "w": 12, "x": 12, "y": 8 },
        "targets": [
          {
            "expr": "pg_stat_database_numbackends{datname=\"vendhub\"}",
            "legendFormat": "Active Connections"
          },
          {
            "expr": "pg_settings_max_connections",
            "legendFormat": "Max Connections"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            }
          },
          "overrides": [
            {
              "matcher": { "id": "byName", "options": "Max Connections" },
              "properties": [
                { "id": "custom.lineStyle", "value": { "fill": "dash" } },
                { "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }
              ]
            }
          ]
        }
      },
      {
        "id": 13,
        "title": "Transaction Rate",
        "type": "timeseries",
        "gridPos": { "h": 6, "w": 12, "x": 0, "y": 14 },
        "targets": [
          {
            "expr": "rate(pg_stat_database_xact_commit{datname=\"vendhub\"}[5m])",
            "legendFormat": "Commits/s"
          },
          {
            "expr": "rate(pg_stat_database_xact_rollback{datname=\"vendhub\"}[5m])",
            "legendFormat": "Rollbacks/s"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 20
            },
            "unit": "ops"
          },
          "overrides": [
            {
              "matcher": { "id": "byName", "options": "Rollbacks/s" },
              "properties": [{ "id": "color", "value": { "fixedColor": "red", "mode": "fixed" } }]
            }
          ]
        }
      },
      {
        "id": 14,
        "title": "Database I/O",
        "type": "timeseries",
        "gridPos": { "h": 6, "w": 12, "x": 12, "y": 14 },
        "targets": [
          {
            "expr": "rate(pg_stat_database_blks_read{datname=\"vendhub\"}[5m])",
            "legendFormat": "Blocks Read/s"
          },
          {
            "expr": "rate(pg_stat_database_blks_hit{datname=\"vendhub\"}[5m])",
            "legendFormat": "Blocks Hit/s (cache)"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 20
            },
            "unit": "ops"
          }
        }
      },
      {
        "id": 102,
        "title": "Redis Metrics",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 20 },
        "collapsed": false
      },
      {
        "id": 20,
        "title": "Redis Memory Usage",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 6, "x": 0, "y": 21 },
        "targets": [
          {
            "expr": "(redis_memory_used_bytes / redis_memory_max_bytes) * 100",
            "legendFormat": "Memory %"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 90 }
              ]
            },
            "min": 0,
            "max": 100,
            "unit": "percent"
          }
        }
      },
      {
        "id": 21,
        "title": "Redis Connected Clients",
        "type": "stat",
        "gridPos": { "h": 6, "w": 6, "x": 6, "y": 21 },
        "targets": [
          {
            "expr": "redis_connected_clients",
            "legendFormat": "Clients"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 100 },
                { "color": "red", "value": 200 }
              ]
            },
            "displayName": "Connected Clients"
          }
        }
      },
      {
        "id": 22,
        "title": "Redis Operations",
        "type": "timeseries",
        "gridPos": { "h": 6, "w": 12, "x": 12, "y": 21 },
        "targets": [
          {
            "expr": "rate(redis_commands_total[5m])",
            "legendFormat": "Commands/s"
          },
          {
            "expr": "rate(redis_keyspace_hits_total[5m])",
            "legendFormat": "Hits/s"
          },
          {
            "expr": "rate(redis_keyspace_misses_total[5m])",
            "legendFormat": "Misses/s"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            },
            "unit": "ops"
          }
        }
      },
      {
        "id": 23,
        "title": "Redis Keys",
        "type": "stat",
        "gridPos": { "h": 3, "w": 6, "x": 0, "y": 27 },
        "targets": [
          {
            "expr": "sum(redis_db_keys)",
            "legendFormat": "Keys"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "none"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [{ "color": "blue", "value": null }]
            },
            "displayName": "Total Keys"
          }
        }
      },
      {
        "id": 24,
        "title": "Redis Expiring Keys",
        "type": "stat",
        "gridPos": { "h": 3, "w": 6, "x": 6, "y": 27 },
        "targets": [
          {
            "expr": "sum(redis_db_keys_expiring)",
            "legendFormat": "Expiring"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "none"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [{ "color": "yellow", "value": null }]
            },
            "displayName": "Expiring Keys"
          }
        }
      },
      {
        "id": 103,
        "title": "Container Metrics",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 30 },
        "collapsed": false
      },
      {
        "id": 30,
        "title": "Container CPU Usage",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 31 },
        "targets": [
          {
            "expr": "sum(rate(container_cpu_usage_seconds_total{name=~\"vendhub.*\"}[5m])) by (name) * 100",
            "legendFormat": "{{ name }}"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right",
            "calcs": ["mean", "max"]
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 20
            },
            "unit": "percent",
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 90 }
              ]
            }
          }
        }
      },
      {
        "id": 31,
        "title": "Container Memory Usage",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 31 },
        "targets": [
          {
            "expr": "container_memory_usage_bytes{name=~\"vendhub.*\"} / 1024 / 1024",
            "legendFormat": "{{ name }}"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right",
            "calcs": ["mean", "max"]
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 20
            },
            "unit": "decmbytes"
          }
        }
      },
      {
        "id": 32,
        "title": "Container Network I/O",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 0, "y": 39 },
        "targets": [
          {
            "expr": "sum(rate(container_network_receive_bytes_total{name=~\"vendhub.*\"}[5m])) by (name)",
            "legendFormat": "{{ name }} RX"
          },
          {
            "expr": "sum(rate(container_network_transmit_bytes_total{name=~\"vendhub.*\"}[5m])) by (name)",
            "legendFormat": "{{ name }} TX"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            },
            "unit": "Bps"
          }
        }
      },
      {
        "id": 33,
        "title": "Container Disk I/O",
        "type": "timeseries",
        "gridPos": { "h": 8, "w": 12, "x": 12, "y": 39 },
        "targets": [
          {
            "expr": "sum(rate(container_fs_reads_bytes_total{name=~\"vendhub.*\"}[5m])) by (name)",
            "legendFormat": "{{ name }} Read"
          },
          {
            "expr": "sum(rate(container_fs_writes_bytes_total{name=~\"vendhub.*\"}[5m])) by (name)",
            "legendFormat": "{{ name }} Write"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "table",
            "placement": "right"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            },
            "unit": "Bps"
          }
        }
      },
      {
        "id": 104,
        "title": "Host Metrics",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 47 },
        "collapsed": false
      },
      {
        "id": 40,
        "title": "Host CPU",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 6, "x": 0, "y": 48 },
        "targets": [
          {
            "expr": "100 - (avg(rate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "CPU %"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 90 }
              ]
            },
            "min": 0,
            "max": 100,
            "unit": "percent"
          }
        }
      },
      {
        "id": 41,
        "title": "Host Memory",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 6, "x": 6, "y": 48 },
        "targets": [
          {
            "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
            "legendFormat": "Memory %"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 90 }
              ]
            },
            "min": 0,
            "max": 100,
            "unit": "percent"
          }
        }
      },
      {
        "id": 42,
        "title": "Host Disk Usage",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 6, "x": 12, "y": 48 },
        "targets": [
          {
            "expr": "(1 - (node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"})) * 100",
            "legendFormat": "Disk %"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 85 }
              ]
            },
            "min": 0,
            "max": 100,
            "unit": "percent"
          }
        }
      },
      {
        "id": 43,
        "title": "System Load",
        "type": "stat",
        "gridPos": { "h": 6, "w": 6, "x": 18, "y": 48 },
        "targets": [
          {
            "expr": "node_load1",
            "legendFormat": "1m"
          },
          {
            "expr": "node_load5",
            "legendFormat": "5m"
          },
          {
            "expr": "node_load15",
            "legendFormat": "15m"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "none",
          "orientation": "horizontal"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 2 },
                { "color": "red", "value": 4 }
              ]
            }
          }
        }
      },
      {
        "id": 105,
        "title": "Storage (MinIO)",
        "type": "row",
        "gridPos": { "h": 1, "w": 24, "x": 0, "y": 54 },
        "collapsed": false
      },
      {
        "id": 50,
        "title": "MinIO Disk Usage",
        "type": "gauge",
        "gridPos": { "h": 6, "w": 8, "x": 0, "y": 55 },
        "targets": [
          {
            "expr": "(minio_cluster_capacity_usable_total_bytes - minio_cluster_capacity_usable_free_bytes) / minio_cluster_capacity_usable_total_bytes * 100",
            "legendFormat": "Used %"
          }
        ],
        "options": {
          "reduceOptions": { "calcs": ["lastNotNull"] },
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [
                { "color": "green", "value": null },
                { "color": "yellow", "value": 70 },
                { "color": "red", "value": 90 }
              ]
            },
            "min": 0,
            "max": 100,
            "unit": "percent"
          }
        }
      },
      {
        "id": 51,
        "title": "MinIO Objects",
        "type": "stat",
        "gridPos": { "h": 6, "w": 8, "x": 8, "y": 55 },
        "targets": [
          {
            "expr": "minio_bucket_objects_count",
            "legendFormat": "{{ bucket }}"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area"
        },
        "fieldConfig": {
          "defaults": {
            "thresholds": {
              "mode": "absolute",
              "steps": [{ "color": "blue", "value": null }]
            },
            "displayName": "Objects"
          }
        }
      },
      {
        "id": 52,
        "title": "MinIO Operations",
        "type": "timeseries",
        "gridPos": { "h": 6, "w": 8, "x": 16, "y": 55 },
        "targets": [
          {
            "expr": "rate(minio_s3_requests_total{api=\"getobject\"}[5m])",
            "legendFormat": "GET"
          },
          {
            "expr": "rate(minio_s3_requests_total{api=\"putobject\"}[5m])",
            "legendFormat": "PUT"
          },
          {
            "expr": "rate(minio_s3_requests_total{api=\"deleteobject\"}[5m])",
            "legendFormat": "DELETE"
          }
        ],
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        },
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            },
            "unit": "ops"
          }
        }
      }
    ]
  }
}
