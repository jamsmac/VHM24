# Incidents & Complaints Documentation

> **Модули**: `backend/src/modules/incidents/`, `backend/src/modules/complaints/`
> **Версия**: 1.0.0
> **Последнее обновление**: 2025-12-20

---

## Обзор

Два связанных модуля для отслеживания проблем:

- **Incidents** - Внутренние инциденты оборудования (регистрируются сотрудниками)
- **Complaints** - Жалобы клиентов (подаются через QR-код без авторизации)

```
┌─────────────────────────────────────────────────────────────────────┐
│              INCIDENTS & COMPLAINTS SYSTEM                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                      INCIDENTS                                 │  │
│  │  ├── 7 типов (technical_failure, out_of_stock, ...)           │  │
│  │  ├── 4 приоритета (low, medium, high, critical)               │  │
│  │  ├── 4 статуса (open → in_progress → resolved → closed)       │  │
│  │  ├── Назначение исполнителей                                  │  │
│  │  └── Учёт стоимости ремонта                                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                      COMPLAINTS                                │  │
│  │  ├── 5 типов (product_quality, no_change, ...)                │  │
│  │  ├── 4 статуса (new → in_review → resolved/rejected)          │  │
│  │  ├── Публичный API через QR-код                               │  │
│  │  ├── Возврат средств                                          │  │
│  │  └── Оценка клиента (1-5)                                     │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Документация

| Документ | Описание |
|----------|----------|
| [01-INCIDENTS.md](./01-INCIDENTS.md) | Инциденты: типы, статусы, workflow, API |
| [02-COMPLAINTS.md](./02-COMPLAINTS.md) | Жалобы: публичный API, QR-коды, возвраты |
| [03-API-REFERENCE.md](./03-API-REFERENCE.md) | Полный REST API Reference |

---

## Быстрый старт

### Создание инцидента

```bash
POST /api/incidents
Authorization: Bearer <token>
{
  "incident_type": "technical_failure",
  "machine_id": "uuid",
  "title": "Не работает кофемолка",
  "priority": "high"
}
```

### Подача жалобы через QR-код

```bash
POST /api/complaints/public/qr
{
  "qr_code": "QR-M7K3F92A8B1C",
  "complaint_type": "product_not_dispensed",
  "description": "Не выдан кофе"
}
```

---

## Сравнение модулей

| Характеристика | Incidents | Complaints |
|----------------|-----------|------------|
| Источник | Сотрудники | Клиенты |
| Авторизация | Требуется | Публичный API |
| Приоритеты | 4 уровня | Нет |
| Назначение | На исполнителя | На обработчика |
| Переоткрытие | Да | Нет |
| Возврат средств | Нет | Да |
| Оценка | Нет | Да (1-5) |

---

## Типы инцидентов

| Код | Описание |
|-----|----------|
| technical_failure | Техническая неисправность |
| out_of_stock | Закончился товар |
| cash_full | Купюроприёмник переполнен |
| cash_discrepancy | Расхождение в инкассации |
| vandalism | Вандализм |
| power_outage | Отключение электричества |
| other | Прочее |

---

## Типы жалоб

| Код | Описание |
|-----|----------|
| product_quality | Качество продукта |
| no_change | Не выдана сдача |
| product_not_dispensed | Продукт не выдан |
| machine_dirty | Грязный аппарат |
| other | Прочее |

---

## Workflow

### Инцидент

```
OPEN → IN_PROGRESS → RESOLVED → CLOSED
         ↑                          │
         └──────── REOPEN ──────────┘
```

### Жалоба

```
NEW → IN_REVIEW → RESOLVED
                  ↓
                REJECTED
```

---

## Права доступа

### Incidents

| Операция | Роли |
|----------|------|
| Просмотр | Все авторизованные |
| CRUD | Admin, Manager, SuperAdmin |

### Complaints

| Операция | Требует авторизации |
|----------|---------------------|
| Создание | Нет (публичный) |
| Просмотр/обработка | Да |
| Удаление | Admin, Manager |

---

## Интеграции

- **Machines** - инциденты и жалобы привязаны к аппаратам
- **Users** - назначение исполнителей/обработчиков
- **Tasks** - создание задач на ремонт
- **Transactions** - транзакции возврата
- **QR Codes** - публичная форма жалобы
- **Notifications** - уведомления о критических событиях

---

## Requirements

| REQ ID | Описание |
|--------|----------|
| REQ-INC-01 | Регистрация инцидентов |
| REQ-INC-10 | Workflow назначения и решения |
| REQ-INC-30 | Учёт стоимости ремонта |
| REQ-COMP-01 | Публичная форма жалоб через QR-код |
| REQ-COMP-11 | Возможность возврата средств |
| REQ-COMP-20 | Rate limiting публичного API |
