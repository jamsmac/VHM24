# Client Platform Documentation

> **Модуль**: `backend/src/modules/client/`
> **Версия**: 1.0.0
> **Последнее обновление**: 2025-12-20

---

## Обзор

Client Platform — публичная клиентская платформа для взаимодействия с вендинговыми аппаратами. Отдельная от Staff Platform система для конечных клиентов.

```
┌─────────────────────────────────────────────────────────────────────┐
│                      CLIENT PLATFORM                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    AUTHENTICATION                              │  │
│  │  ├── Telegram Web App initData                                │  │
│  │  ├── JWT Tokens (access: 1h, refresh: 30d)                    │  │
│  │  └── Автоматическая регистрация                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                     CLIENT USERS                               │  │
│  │  ├── Telegram ID как основной идентификатор                   │  │
│  │  ├── Профиль: имя, телефон, email, язык                       │  │
│  │  └── Предпочтения (JSON)                                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                       ORDERS                                   │  │
│  │  ├── 6 статусов: pending → paid → completed                   │  │
│  │  ├── 5 провайдеров оплаты: Telegram, Click, Payme, Uzum      │  │
│  │  ├── Интеграция с лояльностью (баллы)                         │  │
│  │  └── Привязка к аппарату                                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                     LOYALTY SYSTEM                             │  │
│  │  ├── Начисление: 1% от суммы заказа                           │  │
│  │  ├── Списание: 1 балл = 100 UZS                               │  │
│  │  ├── Бонусы: реферальные, промо                               │  │
│  │  └── История транзакций (ledger)                              │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                   WALLET (Phase 2)                             │  │
│  │  ├── Предоплаченный баланс                                    │  │
│  │  ├── Пополнение через провайдеры                              │  │
│  │  └── Оплата заказов                                           │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │                    PUBLIC API                                  │  │
│  │  ├── Публичное меню аппаратов                                 │  │
│  │  ├── Список локаций и городов                                 │  │
│  │  ├── QR-код резолвер                                          │  │
│  │  └── Форма сотрудничества                                     │  │
│  └───────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Документация

| Документ | Описание |
|----------|----------|
| [01-CLIENT-USERS.md](./01-CLIENT-USERS.md) | Пользователи, Telegram аутентификация |
| [02-ORDERS.md](./02-ORDERS.md) | Заказы, статусы, оплата |
| [03-LOYALTY.md](./03-LOYALTY.md) | Программа лояльности, баллы |
| [04-API-REFERENCE.md](./04-API-REFERENCE.md) | REST API reference |

---

## Быстрый старт

### Telegram аутентификация

```bash
POST /api/client/auth/telegram
{
  "initData": "query_id=AAHdF6IQ...&user=%7B%22id%22%3A12345678..."
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "uuid",
    "telegram_username": "johndoe",
    "full_name": "John Doe",
    "loyalty_points": 150
  }
}
```

### Создание заказа

```bash
POST /api/client/orders
Authorization: Bearer <access_token>

{
  "machine_id": "uuid-аппарата",
  "items": [
    { "product_id": "uuid-капучино", "quantity": 1 }
  ],
  "payment_provider": "telegram",
  "redeem_points": 0
}
```

---

## Staff vs Client Platform

| Характеристика | Staff Platform | Client Platform |
|----------------|----------------|-----------------|
| Пользователи | Операторы, менеджеры | Клиенты |
| Аутентификация | Email/Password + JWT | Telegram Web App |
| Эндпоинты | `/api/*` | `/api/client/*` |
| Роли | 6 ролей RBAC | Нет ролей |
| Функции | Управление, задачи, склад | Заказы, лояльность |

---

## Entities

### Основные

| Entity | Описание |
|--------|----------|
| ClientUser | Пользователь клиентской платформы |
| ClientOrder | Заказ клиента |
| ClientPayment | Платёж через провайдера |

### Лояльность

| Entity | Описание |
|--------|----------|
| ClientLoyaltyAccount | Счёт лояльности (баланс баллов) |
| ClientLoyaltyLedger | Журнал транзакций баллов |

### Кошелёк (Phase 2)

| Entity | Описание |
|--------|----------|
| ClientWallet | Кошелёк (предоплаченный баланс) |
| ClientWalletLedger | Журнал операций кошелька |

---

## Провайдеры оплаты

| Код | Описание | Статус |
|-----|----------|--------|
| telegram | Telegram Payments | ✅ Активен |
| click | Click.uz | ✅ Активен |
| payme | Payme.uz | ✅ Активен |
| uzum | Uzum Bank | ✅ Активен |
| wallet | Внутренний кошелёк | 🔜 Phase 2 |

---

## Программа лояльности

```
┌─────────────────────────────────────────────────────┐
│              LOYALTY PROGRAM                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  НАЧИСЛЕНИЕ                   СПИСАНИЕ              │
│  ───────────────             ────────────           │
│  1% от суммы заказа    →     1 балл = 100 UZS       │
│                                                     │
│  Пример:                     Пример:                │
│  Заказ: 50,000 UZS           Баллов: 100            │
│  Баллы: 500                  Скидка: 10,000 UZS     │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### Типы транзакций

| Код | Описание |
|-----|----------|
| order_earned | Начисление за заказ |
| order_redeemed | Списание на скидку |
| referral_bonus | Реферальный бонус |
| promo_bonus | Промо-бонус |
| manual_adjustment | Ручная корректировка |
| expiration | Истечение срока (планируется) |

---

## Публичный API

Эндпоинты без авторизации:

| Endpoint | Описание |
|----------|----------|
| `GET /api/client/public/locations` | Список локаций |
| `GET /api/client/public/cities` | Список городов |
| `GET /api/client/public/menu?machine_id=` | Меню аппарата |
| `POST /api/client/public/qr/resolve` | Распознать QR-код |
| `POST /api/client/public/cooperation` | Форма сотрудничества |

---

## Token Lifecycle

```
┌──────────────────────────────────────────────────────────┐
│                 CLIENT TOKEN LIFECYCLE                    │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. Telegram Web App открывается                         │
│     └── initData передаётся на /client/auth/telegram     │
│                                                          │
│  2. Сервер валидирует initData                           │
│     ├── Проверка HMAC (hash)                             │
│     ├── Проверка auth_date (не старше 24ч)               │
│     └── Извлечение user data                             │
│                                                          │
│  3. Создание/обновление ClientUser                       │
│     └── Автоматическое создание LoyaltyAccount           │
│                                                          │
│  4. Генерация токенов                                    │
│     ├── access_token (1 час)                             │
│     └── refresh_token (30 дней)                          │
│                                                          │
│  5. Использование API                                    │
│     └── Authorization: Bearer <access_token>             │
│                                                          │
│  6. Обновление токена                                    │
│     └── POST /client/auth/refresh                        │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## Интеграции

- **Machines** - заказы привязаны к аппаратам
- **Nomenclature** - товары для заказов
- **Locations** - публичный список локаций
- **Telegram Bot** - аутентификация, уведомления

---

## Requirements

| REQ ID | Описание |
|--------|----------|
| REQ-CLIENT-01 | Telegram Web App аутентификация |
| REQ-CLIENT-02 | Отдельные пользователи от Staff |
| REQ-CLIENT-10 | Создание и отслеживание заказов |
| REQ-CLIENT-11 | Интеграция с провайдерами оплаты |
| REQ-CLIENT-20 | Программа лояльности с баллами |
| REQ-CLIENT-21 | Начисление 1% от заказа |
| REQ-CLIENT-22 | Списание 1 балл = 100 UZS |
| REQ-CLIENT-30 | Публичное меню без авторизации |
| REQ-CLIENT-40 | Кошелёк (Phase 2) |
