# Client Orders - –ó–∞–∫–∞–∑—ã

> **–ú–æ–¥—É–ª—å**: `backend/src/modules/client/`
> **–í–µ—Ä—Å–∏—è**: 1.0.0
> **–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-12-20

---

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã. –ö–ª–∏–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç –∑–∞–∫–∞–∑—ã —á–µ—Ä–µ–∑ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –≤—ã–±–∏—Ä–∞—è —Ç–æ–≤–∞—Ä—ã –∏–∑ –º–µ–Ω—é –∞–ø–ø–∞—Ä–∞—Ç–∞ –∏ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      CLIENT ORDER SYSTEM                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                    CLIENT ORDER                                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ machine_id                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ (items JSON)                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ 6 —Å—Ç–∞—Ç—É—Å–æ–≤ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞                              ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ 5 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –æ–ø–ª–∞—Ç—ã                                     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å—é                                 ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ –°—É–º–º—ã: total, discount, final                            ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ                   CLIENT PAYMENT                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ provider_tx_id (ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)                ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îú‚îÄ‚îÄ raw_payload (JSON –æ—Ç–≤–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞)                      ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ –°—Ç–∞—Ç—É—Å—ã: pending, success, failed, refunded              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Entity: ClientOrder

```typescript
@Entity('client_orders')
@Index(['client_user_id'])
@Index(['machine_id'])
@Index(['status'])
@Index(['created_at'])
export class ClientOrder {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  // –°–≤—è–∑–∏
  @Column({ type: 'uuid' })
  client_user_id: string;

  @ManyToOne(() => ClientUser, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'client_user_id' })
  client_user: ClientUser;

  @Column({ type: 'uuid' })
  machine_id: string;

  @ManyToOne(() => Machine, { onDelete: 'SET NULL' })
  @JoinColumn({ name: 'machine_id' })
  machine: Machine;

  @Column({ type: 'uuid', nullable: true })
  location_id: string | null;

  @ManyToOne(() => Location, { onDelete: 'SET NULL' })
  @JoinColumn({ name: 'location_id' })
  location: Location | null;

  // –§–∏–Ω–∞–Ω—Å—ã
  @Column({ type: 'decimal', precision: 12, scale: 2 })
  total_amount: number;

  @Column({ type: 'varchar', length: 3, default: 'UZS' })
  currency: string;

  // –û–ø–ª–∞—Ç–∞
  @Column({
    type: 'enum',
    enum: PaymentProvider,
    default: PaymentProvider.TELEGRAM,
  })
  payment_provider: PaymentProvider;

  @Column({ type: 'varchar', length: 255, nullable: true })
  provider_tx_id: string | null;

  @Column({
    type: 'enum',
    enum: ClientOrderStatus,
    default: ClientOrderStatus.PENDING,
  })
  status: ClientOrderStatus;

  // –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞
  @Column({ type: 'jsonb', nullable: true })
  items: Array<{
    product_id: string;
    product_name: string;
    quantity: number;
    price: number;
  }> | null;

  // –õ–æ—è–ª—å–Ω–æ—Å—Ç—å
  @Column({ type: 'integer', default: 0 })
  loyalty_points_earned: number;

  @Column({ type: 'integer', default: 0 })
  loyalty_points_used: number;

  // Timestamps
  @CreateDateColumn({ type: 'timestamp with time zone' })
  created_at: Date;

  @UpdateDateColumn({ type: 'timestamp with time zone' })
  updated_at: Date;

  @Column({ type: 'timestamp with time zone', nullable: true })
  paid_at: Date | null;

  @Column({ type: 'timestamp with time zone', nullable: true })
  completed_at: Date | null;
}
```

---

## ClientOrderStatus

```typescript
export enum ClientOrderStatus {
  PENDING = 'pending',       // –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã
  PAID = 'paid',             // –û–ø–ª–∞—á–µ–Ω
  COMPLETED = 'completed',   // –í—ã–ø–æ–ª–Ω–µ–Ω (—Ç–æ–≤–∞—Ä –≤—ã–¥–∞–Ω)
  FAILED = 'failed',         // –û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã
  CANCELLED = 'cancelled',   // –û—Ç–º–µ–Ω—ë–Ω –∫–ª–∏–µ–Ω—Ç–æ–º
  REFUNDED = 'refunded',     // –í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
}
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–∫–∞–∑–∞

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ PENDING  ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ              ‚îÇ              ‚îÇ
          ‚ñº              ‚ñº              ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  FAILED  ‚îÇ   ‚îÇ   PAID   ‚îÇ   ‚îÇCANCELLED ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇCOMPLETED ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ –¢–æ–≤–∞—Ä –≤—ã–¥–∞–Ω
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ
                       ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ REFUNDED ‚îÇ ‚óÑ‚îÄ‚îÄ‚îÄ –í–æ–∑–≤—Ä–∞—Ç
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## PaymentProvider

```typescript
export enum PaymentProvider {
  TELEGRAM = 'telegram',   // Telegram Payments
  CLICK = 'click',         // Click.uz
  PAYME = 'payme',         // Payme.uz
  UZUM = 'uzum',           // Uzum Bank
  WALLET = 'wallet',       // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ—à–µ–ª—ë–∫ (Phase 2)
}
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

| –ü—Ä–æ–≤–∞–π–¥–µ—Ä | –ö–æ–º–∏—Å—Å–∏—è | –í–∞–ª—é—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|-----------|----------|--------|--------|
| Telegram | ~2% | UZS | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω |
| Click | ~1% | UZS | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω |
| Payme | ~1% | UZS | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω |
| Uzum | ~0.5% | UZS | ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω |
| Wallet | 0% | UZS | üîú Phase 2 |

---

## Entity: ClientPayment

–•—Ä–∞–Ω–∏—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.

```typescript
@Entity('client_payments')
@Index(['client_user_id'])
@Index(['provider'])
@Index(['provider_tx_id'])
@Index(['status'])
export class ClientPayment {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ type: 'uuid' })
  client_user_id: string;

  @ManyToOne(() => ClientUser, { onDelete: 'CASCADE' })
  @JoinColumn({ name: 'client_user_id' })
  client_user: ClientUser;

  @Column({
    type: 'enum',
    enum: PaymentProvider,
  })
  provider: PaymentProvider;

  @Column({ type: 'varchar', length: 255, nullable: true })
  provider_tx_id: string | null;

  @Column({ type: 'decimal', precision: 12, scale: 2 })
  amount: number;

  @Column({ type: 'varchar', length: 3, default: 'UZS' })
  currency: string;

  @Column({
    type: 'enum',
    enum: ClientPaymentStatus,
    default: ClientPaymentStatus.PENDING,
  })
  status: ClientPaymentStatus;

  @Column({ type: 'jsonb', nullable: true })
  raw_payload: Record<string, any> | null;

  @Column({ type: 'text', nullable: true })
  error_message: string | null;

  @CreateDateColumn({ type: 'timestamp with time zone' })
  created_at: Date;

  @Column({ type: 'timestamp with time zone', nullable: true })
  processed_at: Date | null;
}
```

### ClientPaymentStatus

```typescript
export enum ClientPaymentStatus {
  PENDING = 'pending',     // –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
  SUCCESS = 'success',     // –£—Å–ø–µ—à–Ω–æ
  FAILED = 'failed',       // –û—à–∏–±–∫–∞
  REFUNDED = 'refunded',   // –í–æ–∑–≤—Ä–∞—Ç
}
```

---

## –†–∞—Å—á—ë—Ç —Å—É–º–º

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—É–º–º –≤ –∑–∞–∫–∞–∑–µ

```
total_amount        = Œ£ (item.price √ó item.quantity)
discount_amount     = points_redeemed √ó 100 (UZS per point)
final_amount        = total_amount - discount_amount

points_earned       = floor(final_amount √ó 0.01) = 1% –æ—Ç final_amount
points_redeemed     = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤
```

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞

```
–ó–∞–∫–∞–∑:
  –ö–∞–ø—É—á–∏–Ω–æ √ó 1 = 25,000 UZS
  –õ–∞—Ç—Ç–µ √ó 2    = 50,000 UZS
  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  total_amount = 75,000 UZS

–°–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤: 50 –±–∞–ª–ª–æ–≤
  discount_amount = 50 √ó 100 = 5,000 UZS

final_amount = 75,000 - 5,000 = 70,000 UZS

–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤:
  points_earned = floor(70,000 √ó 0.01) = 700 –±–∞–ª–ª–æ–≤
```

---

## –°–µ—Ä–≤–∏—Å ClientOrdersService

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã

```typescript
@Injectable()
export class ClientOrdersService {
  // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  async createOrder(
    clientUser: ClientUser,
    dto: CreateClientOrderDto,
  ): Promise<ClientOrderResponseDto>;

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
  async getOrders(
    clientUser: ClientUser,
    query: ClientOrderQueryDto,
  ): Promise<{ data: ClientOrderResponseDto[]; total: number }>;

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ ID
  async getOrder(
    clientUser: ClientUser,
    orderId: string,
  ): Promise<ClientOrderResponseDto>;

  // –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–∞
  async cancelOrder(
    clientUser: ClientUser,
    orderId: string,
  ): Promise<ClientOrderResponseDto>;
}
```

### –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞

```typescript
async createOrder(clientUser: ClientUser, dto: CreateClientOrderDto) {
  // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –∞–ø–ø–∞—Ä–∞—Ç–∞
  const machine = await this.machineRepository.findOne({
    where: { id: dto.machine_id },
  });
  if (!machine || machine.status !== 'active') {
    throw new BadRequestException('Machine is not available');
  }

  // 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π –∏ —Ä–∞—Å—á—ë—Ç —Å—É–º–º—ã
  let totalAmount = 0;
  const orderItems = [];
  for (const item of dto.items) {
    const product = await this.nomenclatureRepository.findOne({
      where: { id: item.product_id },
    });
    const itemTotal = product.base_price * item.quantity;
    totalAmount += itemTotal;
    orderItems.push({ product_id, name, quantity, unit_price, total_price });
  }

  // 3. –†–∞—Å—á—ë—Ç —Å–ø–∏—Å–∞–Ω–∏—è –±–∞–ª–ª–æ–≤
  if (dto.redeem_points > 0) {
    const balance = await this.loyaltyService.getBalance(clientUser.id);
    const maxRedeemable = Math.min(dto.redeem_points, balance.points_balance);
    discountFromPoints = maxRedeemable * 100; // 1 point = 100 UZS
  }

  // 4. –†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º—ã –∏ –Ω–∞—á–∏—Å–ª—è–µ–º—ã—Ö –±–∞–ª–ª–æ–≤
  const finalAmount = totalAmount - discountFromPoints;
  const pointsEarned = Math.floor(finalAmount / 1000); // 1% = 1 point per 1000 UZS

  // 5. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
  const order = this.orderRepository.create({
    client_user_id: clientUser.id,
    machine_id: dto.machine_id,
    status: ClientOrderStatus.PENDING,
    items: orderItems,
    total_amount: totalAmount,
    discount_amount: discountFromPoints,
    final_amount: finalAmount,
    points_earned: pointsEarned,
    points_redeemed: maxRedeemable,
    payment_provider: dto.payment_provider,
  });

  return await this.orderRepository.save(order);
}
```

---

## API Endpoints

### –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑

```http
POST /api/client/orders
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "machine_id": "uuid-–∞–ø–ø–∞—Ä–∞—Ç–∞",
  "items": [
    { "product_id": "uuid-–∫–∞–ø—É—á–∏–Ω–æ", "quantity": 1 },
    { "product_id": "uuid-–ª–∞—Ç—Ç–µ", "quantity": 2 }
  ],
  "payment_provider": "click",
  "redeem_points": 50,
  "promo_code": "SUMMER2025"
}
```

**Response (201 Created):**
```json
{
  "id": "uuid",
  "status": "pending",
  "total_amount": 75000,
  "discount_amount": 5000,
  "final_amount": 70000,
  "points_earned": 700,
  "points_redeemed": 50,
  "payment_provider": "click",
  "machine": {
    "id": "uuid",
    "name": "Coffee Machine #1",
    "machine_number": "M-001"
  },
  "created_at": "2025-01-15T12:00:00Z",
  "paid_at": null
}
```

### –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤

```http
GET /api/client/orders?status=completed&page=1&limit=10
Authorization: Bearer <access_token>
```

**Query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|----------|
| status | string | –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É |
| page | number | –ù–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (default: 1) |
| limit | number | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ (default: 20) |

**Response:**
```json
{
  "data": [
    {
      "id": "uuid",
      "status": "completed",
      "total_amount": 75000,
      "final_amount": 70000,
      "points_earned": 700,
      "machine": { "id": "uuid", "name": "Coffee Machine #1" },
      "created_at": "2025-01-15T12:00:00Z",
      "paid_at": "2025-01-15T12:01:00Z"
    }
  ],
  "total": 25
}
```

### –ü–æ–ª—É—á–∏—Ç—å –∑–∞–∫–∞–∑ –ø–æ ID

```http
GET /api/client/orders/:id
Authorization: Bearer <access_token>
```

### –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑

```http
DELETE /api/client/orders/:id
Authorization: Bearer <access_token>
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –ú–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–∫–∞–∑—ã —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ `pending` –∏–ª–∏ `created`
- –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Å–ø–∏—Å–∞–Ω–Ω—ã–µ –±–∞–ª–ª—ã

---

## DTO

### CreateClientOrderDto

```typescript
export class CreateClientOrderDto {
  @IsUUID()
  machine_id: string;

  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => OrderItemDto)
  items: OrderItemDto[];

  @IsEnum(PaymentProvider)
  payment_provider: PaymentProvider;

  @IsOptional()
  @IsNumber()
  @Min(0)
  redeem_points?: number;

  @IsOptional()
  @IsString()
  promo_code?: string;
}

export class OrderItemDto {
  @IsUUID()
  product_id: string;

  @IsNumber()
  @Min(1)
  quantity: number;

  @IsOptional()
  @IsNumber()
  @Min(0)
  unit_price?: number;
}
```

### ClientOrderQueryDto

```typescript
export class ClientOrderQueryDto {
  @IsOptional()
  @IsEnum(ClientOrderStatus)
  status?: ClientOrderStatus;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(100)
  limit?: number = 20;
}
```

---

## –ü–æ–∑–∏—Ü–∏–∏ –∑–∞–∫–∞–∑–∞ (items)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSONB:

```json
[
  {
    "product_id": "uuid-1",
    "product_name": "–ö–∞–ø—É—á–∏–Ω–æ",
    "quantity": 1,
    "price": 25000
  },
  {
    "product_id": "uuid-2",
    "product_name": "–õ–∞—Ç—Ç–µ",
    "quantity": 2,
    "price": 25000
  }
]
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å—é

### –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –±–∞–ª–ª–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
2. –†–∞—Å—á—ë—Ç —Å–∫–∏–¥–∫–∏: `redeem_points √ó 100 UZS`
3. –†–∞—Å—á—ë—Ç –Ω–∞—á–∏—Å–ª—è–µ–º—ã—Ö –±–∞–ª–ª–æ–≤: `1% –æ—Ç final_amount`

### –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞

1. –í–æ–∑–≤—Ä–∞—Ç —Å–ø–∏—Å–∞–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤
2. –û—Ç–º–µ–Ω–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤ (–µ—Å–ª–∏ –±—ã–ª–∏)

```typescript
async cancelOrder(clientUser: ClientUser, orderId: string) {
  const order = await this.orderRepository.findOne({ ... });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–º–µ–Ω—ã
  if (![ClientOrderStatus.CREATED, ClientOrderStatus.PENDING_PAYMENT].includes(order.status)) {
    throw new BadRequestException('Order cannot be cancelled');
  }

  // –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤
  if (order.points_redeemed > 0) {
    await this.loyaltyService.addPoints(
      clientUser,
      order.points_redeemed,
      'order_cancelled',
      `Refund for order ${order.id}`,
    );
  }

  order.status = ClientOrderStatus.CANCELLED;
  await this.orderRepository.save(order);
}
```

---

## –°–≤—è–∑–∏

- **ClientUser** - N:1 –≤–ª–∞–¥–µ–ª–µ—Ü –∑–∞–∫–∞–∑–∞
- **Machine** - N:1 –∞–ø–ø–∞—Ä–∞—Ç
- **Location** - N:1 –ª–æ–∫–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- **ClientLoyaltyLedger** - 1:N —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–∞–ª–ª–æ–≤
- **ClientPayment** - 1:N –ø–ª–∞—Ç–µ–∂–∏

---

## Requirements

| REQ ID | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| REQ-CLIENT-10 | –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ —á–µ—Ä–µ–∑ API |
| REQ-CLIENT-11 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –æ–ø–ª–∞—Ç—ã |
| REQ-CLIENT-12 | 6 —Å—Ç–∞—Ç—É—Å–æ–≤ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ |
| REQ-CLIENT-13 | –°–ø–∏—Å–∞–Ω–∏–µ –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–∞–ª–ª–æ–≤ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏ |
| REQ-CLIENT-14 | –û—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–æ–≤ (pending/created) |
| REQ-CLIENT-15 | –í–æ–∑–≤—Ä–∞—Ç –±–∞–ª–ª–æ–≤ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ |
| REQ-CLIENT-16 | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–º–æ-–∫–æ–¥–æ–≤ |
