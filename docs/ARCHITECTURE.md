# VendHub Manager - System Architecture

> **Version**: 1.0.0
> **Last Updated**: 2025-12-19

This document provides a comprehensive view of VendHub Manager's system architecture, including component diagrams, data flows, and technical decisions.

---

## Table of Contents

1. [High-Level Architecture](#1-high-level-architecture)
2. [System Components](#2-system-components)
3. [Data Flow Diagrams](#3-data-flow-diagrams)
4. [Module Architecture](#4-module-architecture)
5. [Database Architecture](#5-database-architecture)
6. [Security Architecture](#6-security-architecture)
7. [Infrastructure](#7-infrastructure)
8. [Key Architectural Decisions](#8-key-architectural-decisions)

---

## 1. HIGH-LEVEL ARCHITECTURE

### System Overview

```
                                    VendHub Manager
    ┌─────────────────────────────────────────────────────────────────────┐
    │                                                                     │
    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
    │  │   Next.js    │  │ React Native │  │  Telegram    │              │
    │  │  Dashboard   │  │  Mobile App  │  │     Bot      │              │
    │  │  (Staff UI)  │  │  (Operators) │  │              │              │
    │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
    │         │                 │                 │                       │
    │         │         ┌───────▼───────┐         │                       │
    │         │         │   API Gateway │         │                       │
    │         └─────────►   (nginx)     ◄─────────┘                       │
    │                   └───────┬───────┘                                 │
    │                           │                                         │
    │                   ┌───────▼───────┐                                 │
    │                   │    NestJS     │                                 │
    │                   │   Backend     │                                 │
    │                   │   REST API    │                                 │
    │                   └───────┬───────┘                                 │
    │                           │                                         │
    │         ┌─────────────────┼─────────────────┐                       │
    │         │                 │                 │                       │
    │  ┌──────▼──────┐  ┌───────▼───────┐  ┌──────▼──────┐               │
    │  │ PostgreSQL  │  │    Redis      │  │   MinIO     │               │
    │  │  Database   │  │  Cache/Queue  │  │   Storage   │               │
    │  └─────────────┘  └───────────────┘  └─────────────┘               │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘
```

### Dual Platform Model

```
┌───────────────────────────────────────────────────────────────────────────┐
│                           VendHub Manager                                  │
│                                                                           │
│   ┌─────────────────────────────┐   ┌─────────────────────────────┐      │
│   │      STAFF PLATFORM         │   │     CLIENT PLATFORM         │      │
│   │                             │   │                             │      │
│   │  ┌─────────────────────┐    │   │  ┌─────────────────────┐    │      │
│   │  │  Admin Dashboard    │    │   │  │  Public Menu Page   │    │      │
│   │  │  (Next.js Web)      │    │   │  │  (QR Code Access)   │    │      │
│   │  └─────────────────────┘    │   │  └─────────────────────┘    │      │
│   │                             │   │                             │      │
│   │  ┌─────────────────────┐    │   │  ┌─────────────────────┐    │      │
│   │  │  Operator App       │    │   │  │  Telegram Web App   │    │      │
│   │  │  (React Native)     │    │   │  │  (Client Auth)      │    │      │
│   │  └─────────────────────┘    │   │  └─────────────────────┘    │      │
│   │                             │   │                             │      │
│   │  Authentication:            │   │  Authentication:            │      │
│   │  • JWT (email/password)     │   │  • Telegram initData        │      │
│   │  • 2FA (TOTP)               │   │  • Session management       │      │
│   │  • Role-based access        │   │                             │      │
│   │                             │   │  Features:                  │      │
│   │  Features:                  │   │  • View machine menu        │      │
│   │  • Machine management       │   │  • Place orders             │      │
│   │  • Task workflows           │   │  • Loyalty points           │      │
│   │  • Inventory control        │   │  • Order tracking           │      │
│   │  • Financial operations     │   │                             │      │
│   │  • Analytics & reports      │   │                             │      │
│   │                             │   │                             │      │
│   │  API: /api/*                │   │  API: /api/client/*         │      │
│   └─────────────────────────────┘   └─────────────────────────────┘      │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 2. SYSTEM COMPONENTS

### Backend Architecture (NestJS)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           NestJS Backend                                 │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                        HTTP Layer                                   │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │
│  │  │ Guards   │ │Intercept.│ │  Pipes   │ │ Filters  │ │Middleware│ │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                     Controller Layer                                │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐  │ │
│  │  │  Auth   │ │Machines │ │  Tasks  │ │Inventory│ │ Client API  │  │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                      Service Layer                                  │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────┐  │ │
│  │  │AuthSvc  │ │MachineSv│ │ TaskSvc │ │InvSvc   │ │ ClientSvc   │  │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────────┘  │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                    Data Access Layer                                │ │
│  │  ┌─────────────────────────────────────────────────────────────┐   │ │
│  │  │                    TypeORM Repositories                      │   │ │
│  │  │  • Entity definitions  • Relations  • Migrations • Queries  │   │ │
│  │  └─────────────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                     Supporting Services                             │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │
│  │  │Bull Queue│ │Telegram  │ │  Email   │ │ WebPush  │ │Scheduled │ │ │
│  │  │ (Jobs)   │ │   Bot    │ │ Service  │ │ Service  │ │  Tasks   │ │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Frontend Architecture (Next.js)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Next.js Frontend                                │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                         App Router                                  │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐ │ │
│  │  │  (auth)/    │  │  (public)/  │  │       dashboard/            │ │ │
│  │  │  • login    │  │  • menu/    │  │  • machines, tasks          │ │ │
│  │  │  • register │  │  • order/   │  │  • inventory, reports       │ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                      Component Layer                                │ │
│  │  ┌───────────────────────────────────────────────────────────────┐ │ │
│  │  │  ui/          │  machines/   │  tasks/       │  inventory/    │ │ │
│  │  │  (Shadcn UI)  │  components  │  components   │  components    │ │ │
│  │  └───────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                       State Management                              │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │   Zustand    │  │ TanStack     │  │      React Hook Form     │ │ │
│  │  │ (App State)  │  │ Query (Data) │  │      (Form State)        │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                        API Layer                                    │ │
│  │  ┌───────────────────────────────────────────────────────────────┐ │ │
│  │  │  lib/api.ts  - API client with axios, auth interceptors       │ │ │
│  │  └───────────────────────────────────────────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### Mobile Architecture (React Native/Expo)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      React Native Mobile App                             │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────────┐ │
│  │                       Navigation Layer                              │ │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐ │ │
│  │  │  AppNavigator    │  │  MainNavigator   │  │ ClientNavigator  │ │ │
│  │  │  (Root)          │  │  (Staff)         │  │ (Customer)       │ │ │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                        Screen Layer                                 │ │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │ │
│  │  │  Auth    │ │  Tasks   │ │Equipment │ │ Profile  │ │  Client  │ │ │
│  │  │ Screens  │ │ Screens  │ │ Screens  │ │ Screen   │ │ Screens  │ │ │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                    │                                     │
│  ┌────────────────────────────────▼───────────────────────────────────┐ │
│  │                     State & Services                                │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │ │
│  │  │   Zustand    │  │   API        │  │    Native Modules        │ │ │
│  │  │   Store      │  │   Services   │  │   (Camera, Location)     │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────────────────┘ │ │
│  └────────────────────────────────────────────────────────────────────┘ │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. DATA FLOW DIAGRAMS

### Task Completion Flow (Core Business Process)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        TASK COMPLETION FLOW                               │
│                                                                           │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐         ┌─────────┐│
│  │ Manager │         │ System  │         │Operator │         │ Machine ││
│  └────┬────┘         └────┬────┘         └────┬────┘         └────┬────┘│
│       │                   │                   │                   │     │
│       │ 1. Create Task    │                   │                   │     │
│       │──────────────────►│                   │                   │     │
│       │                   │                   │                   │     │
│       │                   │ 2. Notify         │                   │     │
│       │                   │──────────────────►│                   │     │
│       │                   │   (Push/Telegram) │                   │     │
│       │                   │                   │                   │     │
│       │                   │                   │ 3. Accept Task    │     │
│       │                   │◄──────────────────│                   │     │
│       │                   │                   │                   │     │
│       │                   │                   │ 4. Take BEFORE    │     │
│       │                   │◄──────────────────│    Photo          │     │
│       │                   │   (with location) │                   │     │
│       │                   │                   │                   │     │
│       │                   │                   │ 5. Service        │     │
│       │                   │                   │──────────────────►│     │
│       │                   │                   │   Machine         │     │
│       │                   │                   │                   │     │
│       │                   │                   │ 6. Take AFTER     │     │
│       │                   │◄──────────────────│    Photo          │     │
│       │                   │                   │                   │     │
│       │                   │ 7. Validate       │                   │     │
│       │                   │   Photos          │                   │     │
│       │                   │                   │                   │     │
│       │                   │ 8. Update         │                   │     │
│       │                   │   Inventory       │                   │     │
│       │                   │   (3 levels)      │                   │     │
│       │                   │                   │                   │     │
│       │◄──────────────────│ 9. Task Completed │                   │     │
│       │   Notification    │                   │                   │     │
│       │                   │                   │                   │     │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3-Level Inventory Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      3-LEVEL INVENTORY SYSTEM                             │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        WAREHOUSE LEVEL                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐│ │
│  │  │  • Central stock storage                                        ││ │
│  │  │  • Receives purchase orders                                     ││ │
│  │  │  • Tracks: quantity, reserved_quantity                          ││ │
│  │  └─────────────────────────────────────────────────────────────────┘│ │
│  └───────────────────────────────┬─────────────────────────────────────┘ │
│                                  │                                        │
│                         Transfer to Operator                              │
│                                  │                                        │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        OPERATOR LEVEL                                │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐│ │
│  │  │  • Personal inventory per operator                              ││ │
│  │  │  • Received from warehouse before routes                        ││ │
│  │  │  • Tracks: quantity per user + nomenclature                     ││ │
│  │  └─────────────────────────────────────────────────────────────────┘│ │
│  └───────────────────────────────┬─────────────────────────────────────┘ │
│                                  │                                        │
│                         Refill Task Completion                            │
│                                  │                                        │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                        MACHINE LEVEL                                 │ │
│  │  ┌─────────────────────────────────────────────────────────────────┐│ │
│  │  │  • Stock loaded in vending machine                              ││ │
│  │  │  • Updated on refill task completion                            ││ │
│  │  │  • Tracks: quantity, slot_number per machine + nomenclature     ││ │
│  │  └─────────────────────────────────────────────────────────────────┘│ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  Inventory Operations:                                                    │
│  • Transfer (warehouse → operator, operator → warehouse)                  │
│  • Refill (operator → machine via task)                                   │
│  • Adjustment (corrections with reason)                                   │
│  • Reservation (for pending tasks)                                        │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Authentication Flow

```
┌──────────────────────────────────────────────────────────────────────────┐
│                     AUTHENTICATION FLOWS                                  │
│                                                                           │
│  STAFF AUTHENTICATION (JWT)                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                      │ │
│  │  Client              Backend                   Database              │ │
│  │    │                    │                         │                  │ │
│  │    │ POST /auth/login   │                         │                  │ │
│  │    │ {email, password}  │                         │                  │ │
│  │    │───────────────────►│                         │                  │ │
│  │    │                    │ Verify credentials      │                  │ │
│  │    │                    │────────────────────────►│                  │ │
│  │    │                    │                         │                  │ │
│  │    │                    │◄────────────────────────│                  │ │
│  │    │                    │                         │                  │ │
│  │    │                    │ Generate JWT            │                  │ │
│  │    │                    │ (access: 15m,           │                  │ │
│  │    │◄───────────────────│  refresh: 7d)           │                  │ │
│  │    │                    │                         │                  │ │
│  │    │ API Request        │                         │                  │ │
│  │    │ (Bearer token)     │                         │                  │ │
│  │    │───────────────────►│                         │                  │ │
│  │    │                    │ Validate token          │                  │ │
│  │    │                    │ Check roles             │                  │ │
│  │    │◄───────────────────│                         │                  │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  CLIENT AUTHENTICATION (Telegram)                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                      │ │
│  │  TG WebApp           Backend                   Telegram API          │ │
│  │    │                    │                         │                  │ │
│  │    │ POST /client/auth  │                         │                  │ │
│  │    │ {initData}         │                         │                  │ │
│  │    │───────────────────►│                         │                  │ │
│  │    │                    │ Validate initData       │                  │ │
│  │    │                    │ (HMAC signature)        │                  │ │
│  │    │                    │────────────────────────►│                  │ │
│  │    │                    │                         │                  │ │
│  │    │                    │◄────────────────────────│                  │ │
│  │    │                    │                         │                  │ │
│  │    │                    │ Create/Find client_user │                  │ │
│  │    │                    │ Generate session        │                  │ │
│  │    │◄───────────────────│                         │                  │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 4. MODULE ARCHITECTURE

### Backend Module Organization

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        BACKEND MODULES (45)                               │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                         CORE MODULES                                 │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────────┐   │ │
│  │  │   auth    │ │   users   │ │ machines  │ │  machine-access   │   │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────────────┘   │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │ │
│  │  │   tasks   │ │ inventory │ │transactions│                        │ │
│  │  └───────────┘ └───────────┘ └───────────┘                         │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                       BUSINESS MODULES                               │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │ │
│  │  │ incidents │ │complaints │ │ equipment │ │  routes   │           │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │ │
│  │  │nomenclature│ │  recipes │ │ locations │ │dictionaries│          │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                     INTEGRATION MODULES                              │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │ │
│  │  │ telegram  │ │telegram-bot│ │   email  │ │  web-push │           │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │ │
│  │  ┌───────────┐ ┌───────────┐                                       │ │
│  │  │notifications│ │ websocket│                                       │ │
│  │  └───────────┘ └───────────┘                                        │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                       CLIENT PLATFORM                                │ │
│  │  ┌───────────────────────────────────────────────────────────────┐  │ │
│  │  │                        client/                                 │  │ │
│  │  │   entities/   services/   controllers/   guards/   dto/       │  │ │
│  │  │   • ClientUser  • ClientOrderService  • ClientController      │  │ │
│  │  │   • ClientOrder • ClientLoyaltyService • ClientAuthGuard      │  │ │
│  │  │   • ClientFavorite                                            │  │ │
│  │  └───────────────────────────────────────────────────────────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                      SUPPORTING MODULES                              │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │ │
│  │  │ analytics │ │  reports  │ │audit-logs │ │ monitoring│           │ │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                         │ │
│  │  │   files   │ │sales-import│ │intelligent-import│                  │ │
│  │  └───────────┘ └───────────┘ └───────────┘                          │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Standard Module Structure

```
module-name/
├── dto/
│   ├── create-entity.dto.ts      # Input validation for create
│   ├── update-entity.dto.ts      # Input validation for update
│   └── entity-response.dto.ts    # Response transformation
├── entities/
│   └── entity.entity.ts          # TypeORM entity definition
├── module-name.controller.ts     # HTTP endpoints
├── module-name.service.ts        # Business logic
├── module-name.module.ts         # NestJS module definition
└── module-name.service.spec.ts   # Unit tests
```

---

## 5. DATABASE ARCHITECTURE

### Entity Relationship Diagram (Simplified)

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        DATABASE SCHEMA (108 entities)                     │
│                                                                           │
│   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐   │
│   │    users    │◄──────────│machine_access│──────────►│  machines   │   │
│   │             │           │             │           │             │   │
│   │ id (PK)     │           │ id (PK)     │           │ id (PK)     │   │
│   │ email       │           │ user_id (FK)│           │ machine_    │   │
│   │ password    │           │ machine_id  │           │   number    │   │
│   │ role        │           │ role        │           │ status      │   │
│   │ status      │           └─────────────┘           │ location_id │   │
│   │ telegram_id │                                     └──────┬──────┘   │
│   └──────┬──────┘                                            │          │
│          │                                                   │          │
│          │                    ┌─────────────┐                │          │
│          │                    │   tasks     │                │          │
│          └───────────────────►│             │◄───────────────┘          │
│                               │ id (PK)     │                            │
│                               │ type        │                            │
│                               │ status      │                            │
│                               │ machine_id  │                            │
│                               │ assigned_to │                            │
│                               └──────┬──────┘                            │
│                                      │                                   │
│          ┌───────────────────────────┼───────────────────────────┐      │
│          │                           │                           │      │
│          ▼                           ▼                           ▼      │
│   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐   │
│   │ task_items  │           │task_comments│           │   files     │   │
│   │             │           │             │           │             │   │
│   │ id (PK)     │           │ id (PK)     │           │ id (PK)     │   │
│   │ task_id     │           │ task_id     │           │ entity_type │   │
│   │ nomenclature│           │ user_id     │           │ entity_id   │   │
│   │ quantity    │           │ text        │           │ category    │   │
│   └─────────────┘           └─────────────┘           └─────────────┘   │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    INVENTORY TABLES                              │   │
│   │                                                                  │   │
│   │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │   │
│   │  │   warehouse_   │  │   operator_    │  │   machine_     │    │   │
│   │  │   inventory    │  │   inventory    │  │   inventory    │    │   │
│   │  │                │  │                │  │                │    │   │
│   │  │ nomenclature_id│  │ user_id        │  │ machine_id     │    │   │
│   │  │ quantity       │  │ nomenclature_id│  │ nomenclature_id│    │   │
│   │  │ reserved       │  │ quantity       │  │ quantity       │    │   │
│   │  └────────────────┘  └────────────────┘  └────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    CLIENT PLATFORM TABLES                        │   │
│   │                                                                  │   │
│   │  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐    │   │
│   │  │  client_users  │  │ client_orders  │  │client_favorites│    │   │
│   │  │                │  │                │  │                │    │   │
│   │  │ telegram_id    │  │ client_id      │  │ client_id      │    │   │
│   │  │ points_balance │  │ machine_id     │  │ machine_id     │    │   │
│   │  │ level          │  │ status         │  │ nomenclature_id│    │   │
│   │  └────────────────┘  └────────────────┘  └────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 6. SECURITY ARCHITECTURE

### Security Layers

```
┌──────────────────────────────────────────────────────────────────────────┐
│                        SECURITY ARCHITECTURE                              │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                      NETWORK LAYER                                   │ │
│  │  • HTTPS only (TLS 1.3)                                             │ │
│  │  • Nginx reverse proxy                                              │ │
│  │  • Rate limiting (100/min default, 3/sec for sensitive endpoints)   │ │
│  │  • CORS configuration                                               │ │
│  │  • Helmet.js security headers                                       │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    AUTHENTICATION LAYER                              │ │
│  │  • JWT tokens (access: 15min, refresh: 7 days)                      │ │
│  │  • 2FA via TOTP (Speakeasy)                                         │ │
│  │  • Password hashing (bcrypt, cost factor 12)                        │ │
│  │  • Session management (Redis)                                       │ │
│  │  • Telegram initData validation (client platform)                   │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    AUTHORIZATION LAYER                               │ │
│  │  System Roles:                                                       │ │
│  │  • SuperAdmin - Full system access                                  │ │
│  │  • Admin - Organization management                                  │ │
│  │  • Manager - Operations oversight                                   │ │
│  │  • Operator - Task execution                                        │ │
│  │  • Technician - Maintenance tasks                                   │ │
│  │  • Viewer - Read-only access                                        │ │
│  │                                                                      │ │
│  │  Machine-Level Roles:                                               │ │
│  │  • Owner, Admin, Manager, Operator, Technician, Viewer              │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                    │                                      │
│                                    ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                      DATA LAYER                                      │ │
│  │  • Input validation (class-validator DTOs)                          │ │
│  │  • SQL injection prevention (TypeORM parameterized queries)         │ │
│  │  • XSS prevention (output encoding)                                 │ │
│  │  • Sensitive data encryption (AES-256)                              │ │
│  │  • Audit logging (all write operations)                             │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 7. INFRASTRUCTURE

### Deployment Architecture

```
┌──────────────────────────────────────────────────────────────────────────┐
│                      DEPLOYMENT ARCHITECTURE                              │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                         CDN / Load Balancer                          │ │
│  │                        (Cloudflare / Railway)                        │ │
│  └───────────────────────────────┬─────────────────────────────────────┘ │
│                                  │                                        │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                          APPLICATION TIER                            │ │
│  │                                                                      │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │   Frontend   │  │   Backend    │  │  Telegram    │              │ │
│  │  │   (Next.js)  │  │   (NestJS)   │  │     Bot      │              │ │
│  │  │              │  │              │  │              │              │ │
│  │  │ Railway      │  │ Railway      │  │ Railway      │              │ │
│  │  │ Container    │  │ Container    │  │ Container    │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                  │                                        │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                           DATA TIER                                  │ │
│  │                                                                      │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │  PostgreSQL  │  │    Redis     │  │Cloudflare R2 │              │ │
│  │  │              │  │              │  │   (MinIO)    │              │ │
│  │  │ Railway      │  │ Railway      │  │              │              │ │
│  │  │ Managed      │  │ Managed      │  │ File Storage │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                  │                                        │
│                                  ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                       MONITORING TIER                                │ │
│  │                                                                      │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │ │
│  │  │  Prometheus  │  │   Grafana    │  │    Sentry    │              │ │
│  │  │  (Metrics)   │  │ (Dashboards) │  │   (Errors)   │              │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Local Development Setup

```
┌──────────────────────────────────────────────────────────────────────────┐
│                    LOCAL DEVELOPMENT (docker-compose)                     │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                                                                      │ │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐    │ │
│  │  │  postgres  │  │   redis    │  │   minio    │  │  backend   │    │ │
│  │  │   :5432    │  │   :6379    │  │ :9000/:9001│  │   :3000    │    │ │
│  │  └────────────┘  └────────────┘  └────────────┘  └────────────┘    │ │
│  │                                                                      │ │
│  │  ┌────────────┐                                                     │ │
│  │  │  frontend  │                                                     │ │
│  │  │   :3001    │                                                     │ │
│  │  └────────────┘                                                     │ │
│  │                                                                      │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
│                                                                           │
│  Commands:                                                                │
│  • docker-compose up -d           # Start all services                   │
│  • docker-compose logs -f backend # View backend logs                    │
│  • docker-compose down            # Stop all services                    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 8. KEY ARCHITECTURAL DECISIONS

### Decision 1: Manual Operations Architecture

**Decision**: No direct machine connectivity - all data through operator actions.

**Rationale**:
- Eliminates expensive telemetry infrastructure
- Works with any vending machine (no special hardware)
- Photo validation ensures accountability
- Lower operational costs

**Implications**:
- All status updates are operator-initiated
- Photos are mandatory for task completion
- Inventory relies on operator accuracy

---

### Decision 2: 3-Level Inventory System

**Decision**: Track inventory at warehouse, operator, and machine levels.

**Rationale**:
- Complete visibility of stock location
- Accurate accountability per operator
- Enables shortage/loss detection

**Implications**:
- More complex inventory operations
- Must update all levels on task completion
- Reservation system for pending tasks

---

### Decision 3: Dual Platform Model

**Decision**: Separate Staff and Client platforms with different auth mechanisms.

**Rationale**:
- Different user needs and security requirements
- Client simplicity via Telegram auth
- Staff robustness via JWT + 2FA

**Implications**:
- Separate API endpoints (/api vs /api/client)
- Different auth guards and middleware
- Shared database, separate access patterns

---

### Decision 4: Task-Centric Workflow

**Decision**: All operations flow through the task system.

**Rationale**:
- Centralizes workflow management
- Enables photo validation and SLA tracking
- Provides complete audit trail

**Implications**:
- Tasks are the primary business entity
- Inventory/financial updates tied to tasks
- Reporting centered on task data

---

**Document Version**: 1.0.0
**Last Updated**: 2025-12-19
**Project**: VendHub Manager (VHM24)
