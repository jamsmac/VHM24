# Roadmap VendHub Manager

## Общая информация

**Цель**: Создать рабочую систему управления вендинговой сетью БЕЗ прямой интеграции с аппаратами

**Подход**: Agile, итеративная разработка

**Продолжительность**: ~3 месяца (12 недель)

**Критерий готовности**: Система может использоваться для управления 31 существующим аппаратом

---

## Фаза 1: MVP (4 недели)

### Цель фазы
Создать минимально жизнеспособный продукт, который позволит начать работу с операторами и контролировать основные операции.

### Неделя 1: Инфраструктура и фундамент

#### Backend

```yaml
Задачи:
  - Настройка проекта (NestJS/FastAPI)
  - Подключение PostgreSQL + Redis
  - Конфигурация Docker + Docker Compose
  - Базовая структура API
  - Аутентификация (JWT + refresh tokens)

Результат:
  - Проект запускается через docker-compose up
  - Есть /api/health endpoint
  - Работает регистрация и логин
```

#### Database

```yaml
Задачи:
  - Создание схемы БД (30+ таблиц)
  - Миграции (TypeORM/Alembic)
  - Seeding справочников (30+ справочников)
  - Индексы и ограничения

Результат:
  - npm run migration:run создаёт все таблицы
  - npm run seed:dictionaries загружает справочники
```

#### Frontend (Web)

```yaml
Задачи:
  - Настройка Next.js 14 + shadcn/ui
  - Аутентификация
  - Базовая навигация
  - Первые UI компоненты (кнопки, формы, таблицы)

Результат:
  - Можно войти в систему
  - Видна навигация (пусто, но структура есть)
```

#### Пользователи и роли

```yaml
Задачи:
  - CRUD пользователей
  - Роли (SuperAdmin, Admin, Operator, Collector, Technician)
  - RBAC (Role-Based Access Control)
  - 2FA (опционально для MVP)

Результат:
  - Можно создать пользователей с разными ролями
  - Разные пользователи видят разные меню
```

**Итог недели 1**: Фундамент готов, можно строить фичи

---

### Неделя 2: Основные справочники и объекты

#### Локации

```yaml
Задачи:
  - Модель Location
  - CRUD локаций в web-панели
  - Карта (опционально, можно позже)

Поля:
  - Название, адрес, GPS
  - Тип локации
  - Владелец (контрагент)
  - Контакты, график доступа
  - Условия размещения

Результат:
  - Можно добавить 31 существующую локацию
```

#### Аппараты

```yaml
Задачи:
  - Модель Machine
  - CRUD аппаратов
  - Привязка к локации
  - Назначение оператора/техника
  - Статусы (вручную)

Поля:
  - Код, название, модель
  - Локация
  - Операторы
  - Статус (active/inactive/maintenance/error)
  - Даты (установка, последнее обслуживание)

Результат:
  - Можно добавить 31 существующий аппарат
  - Видна таблица всех аппаратов
```

#### Номенклатура

```yaml
Задачи:
  - Модель Nomenclature (товары + ингредиенты)
  - CRUD номенклатуры
  - Категории, единицы измерения
  - Цены (закупка, продажа)

Результат:
  - Можно добавить напитки (капучино, латте, ...)
  - Можно добавить ингредиенты (кофе, молоко, ...)
  - Можно добавить снеки
```

#### Рецепты

```yaml
Задачи:
  - Модель Recipe + RecipeItem
  - Создание рецепта (товар → ингредиенты)
  - Автоматический расчёт себестоимости
  - Типы рецептов (primary/alternative/test)

Результат:
  - Для каждого напитка есть рецепт
  - Видна себестоимость
```

#### Контрагенты

```yaml
Задачи:
  - Модель Counterparty
  - CRUD контрагентов
  - Типы (поставщики, владельцы локаций)

Результат:
  - Можно добавить поставщиков товаров/сырья
  - Можно добавить владельцев локаций
```

**Итог недели 2**: Все основные объекты созданы, можно начинать работать с задачами

---

### Неделя 3: Задачи (центральный функционал)

#### Модель задач

```yaml
Задачи:
  - Модель Task
  - Типы задач из справочника
  - Статусы, приоритеты
  - Назначение исполнителя
  - Связь с аппаратом

Типы задач:
  - Пополнение (refill)
  - Инкассация (collection)
  - Ремонт (repair)
  - ТО (maintenance)
  - Мойка компонента (cleaning)
  - Установка (installation)
  - Снятие (removal)
  - Ревизия (inspection)
```

#### Задача: Пополнение

```yaml
Функционал:
  - Создание задачи пополнения
  - task_items (список товаров с плановыми количествами)
  - Назначение оператору
  - Выполнение:
    * Фото ДО (обязательно)
    * Внесение фактических количеств
    * Фото ПОСЛЕ (обязательно)
    * Чек-лист
  - Валидация при закрытии
  - Автоматическое обновление остатков

Результат:
  - Оператор может выполнить пополнение
  - Остатки обновляются
```

#### Задача: Инкассация

```yaml
Функционал:
  - Создание задачи инкассации
  - Фото счётчика аппарата (обязательно)
  - Фото денег (обязательно)
  - Внесение фактической суммы
  - Расчёт расхождения (если есть импорт продаж)
  - Создание финансовой операции

Результат:
  - Инкассатор может выполнить сбор
  - Деньги зафиксированы
```

#### Чек-листы

```yaml
Задачи:
  - Модель TaskChecklistItem
  - Шаблоны чек-листов для каждого типа задачи
  - Динамическое добавление пунктов
  - Обязательность выполнения

Результат:
  - При создании задачи автоматически добавляется чек-лист
  - Нельзя закрыть задачу без отметки всех пунктов
```

#### Фото-отчёты

```yaml
Задачи:
  - Модель Files (полиморфная связь)
  - Загрузка фото к задаче
  - Категории (task_photo_before, task_photo_after)
  - Теги для поиска
  - Валидация наличия фото

Результат:
  - Нельзя закрыть задачу без фото ДО/ПОСЛЕ
  - Админ видит все фото в задаче
```

#### Комментарии и чат

```yaml
Задачи:
  - Модель TaskComment
  - Отправка сообщения по задаче
  - Уведомление собеседнику
  - История переписки

Результат:
  - Оператор может написать админу
  - Админ может ответить
```

**Итог недели 3**: Полностью работающая система задач

---

### Неделя 4: Telegram-бот (базовый) и уведомления

#### Telegram-бот

```yaml
Задачи:
  - Настройка Telegram Bot API
  - Регистрация пользователя (привязка к аккаунту)
  - Команды:
    /start - регистрация
    /tasks - мои задачи
    /task [id] - детали задачи
  - Inline кнопки

Функционал для оператора:
  - Просмотр списка задач
  - Принять задачу
  - Загрузить фото
  - Ввести количества (через inline клавиатуру)
  - Отметить чек-лист
  - Завершить задачу

Результат:
  - Оператор может выполнить пополнение через Telegram
```

#### Уведомления

```yaml
Задачи:
  - Модель Notification
  - Типы уведомлений (из справочника)
  - Отправка в Telegram
  - Отправка Email (опционально для MVP)

События:
  - Задача назначена → уведомление исполнителю
  - Новый комментарий → уведомление участникам
  - Задача просрочена → уведомление админу

Результат:
  - При создании задачи оператор получает уведомление
```

#### Audit Logs

```yaml
Задачи:
  - Модель AuditLog (партиционирование)
  - Автоматическое логирование:
    * Изменение цен
    * Удаление записей
    * Изменение остатков
    * Финансовые операции
  - Интерфейс просмотра логов (для админа)

Результат:
  - Все критичные действия логируются
  - Админ может посмотреть "кто что изменил"
```

#### Тестирование MVP

```yaml
Задачи:
  - Unit тесты (критичные функции)
  - Integration тесты (API endpoints)
  - E2E тесты (Playwright) - основные потоки
  - Ручное тестирование

Результат:
  - Покрытие >60%
  - Основные потоки работают
```

**Итог недели 4**: MVP готов к использованию!

---

## Результат Фазы 1 (MVP)

### Что работает:

✅ Можно войти в систему (web)
✅ Добавлены 31 аппарат и локации
✅ Созданы товары, ингредиенты, рецепты
✅ Созданы пользователи (операторы, техники, админы)
✅ Можно создать задачу пополнения
✅ Оператор получает задачу в Telegram
✅ Оператор выполняет пополнение (фото ДО/ПОСЛЕ, количества, чек-лист)
✅ Задача закрывается, остатки обновляются
✅ Можно выполнить инкассацию (фото денег)
✅ Финансовая операция создаётся
✅ Есть чат по задаче
✅ Все действия логируются

### Что НЕ работает (и это ОК для MVP):

❌ Импорт продаж (будет в Фазе 2)
❌ Трёхуровневые остатки (будет в Фазе 2)
❌ Компоненты и их мойка (будет в Фазе 2)
❌ Инциденты (будет в Фазе 2)
❌ Жалобы клиентов (будет в Фазе 2)
❌ Рейтинг операторов (будет в Фазе 3)
❌ Отчёты (будут в Фазе 3)

### Можно начинать использовать!

На этом этапе система уже приносит пользу:
- Операторы работают через Telegram
- Админы контролируют выполнение задач
- Фото-отчёты документируют всё
- Инкассации фиксируются

---

## Фаза 2: Important Features (4 недели)

### Цель фазы
Добавить критически важные функции для полноценного управления бизнесом.

### Неделя 5-6: Продажи и остатки

#### Импорт продаж

```yaml
Задачи:
  - Модель Transaction (партиционирование!)
  - Модель ImportBatch
  - Парсинг Excel/CSV (20 колонок)
  - Сопоставление:
    * machine_code → machines.code
    * product_name → nomenclature.name
    * payment_type → payment_types.code
  - Создание транзакций
  - Обработка ошибок

Web-интерфейс:
  - Страница "Импорт продаж"
  - Загрузка файла
  - Preview (первые 10 строк)
  - Ручное сопоставление (если не найдено)
  - Подтверждение импорта
  - Просмотр истории импортов

Результат:
  - Можно загрузить файл продаж
  - Транзакции создаются
  - Видна статистика по продажам
```

#### Трёхуровневая система остатков

```yaml
Задачи:
  - Модель WarehouseInventory (склады)
  - Модель UserInventory (у операторов)
  - Модель MachineInventory (в аппаратах)
  - Модель InventoryMovement

Логика:
  1. Создание задачи пополнения:
     → Резервирование на складе (reserved_quantity)

  2. Оператор берёт товары:
     → Склад ↓, У оператора ↑
     → Создаётся движение

  3. Оператор пополняет аппарат:
     → У оператора ↓, В аппарате ↑
     → Создаётся движение

  4. Продажа (из импорта):
     → В аппарате ↓
     → Создаётся движение

Web-интерфейс:
  - Остатки по складам
  - Что у операторов (товары в пути)
  - Остатки в аппаратах
  - История движений
  - Алерты на низкие остатки

Результат:
  - Полный контроль где находятся товары
  - Нет "чёрных дыр"
```

---

### Неделя 7: Оборудование и компоненты

#### Компоненты (нумерованные)

```yaml
Задачи:
  - Модель Component
  - Серийные номера (BUN-001, GRN-001, BRW-001, MIX-001)
  - Типы компонентов (из справочника)
  - Подтипы (для бункеров: coffee/milk/sugar/cocoa)
  - Статусы (из справочника)
  - Текущее расположение (полиморфное)

CRUD:
  - Добавить компонент
  - Указать serial_number
  - Выбрать тип и подтип
  - Установить начальное местоположение

Результат:
  - Все компоненты 31 аппарата занумерованы
```

#### График мойки (автоматический)

```yaml
Задачи:
  - Расчёт next_cleaning_due при создании компонента
  - Автоматическая проверка каждый день в 01:00:
    FOR component IN components:
      IF component.next_cleaning_due < TODAY:
        CREATE task:
          type = cleaning
          component_id = component.id
        NOTIFY technician

  - После выполнения задачи мойки:
    → last_cleaning_date = TODAY
    → cleaning_count++
    → next_cleaning_due = TODAY + cleaning_interval_days

Результат:
  - Задачи мойки создаются автоматически
  - Техник получает уведомление
```

#### Задача: Мойка компонента

```yaml
Функционал:
  - Выбор компонента (по serial_number)
  - Демонтаж:
    * Фото ДО
    * Статус → being_cleaned
  - Мойка (вне системы)
  - Подтверждение:
    * Фото ПОСЛЕ
    * Оценка состояния
  - Закрытие:
    * Обновление дат
    * Статус → in_storage или установка в аппарат

Результат:
  - Техник может выполнить мойку через Telegram
```

#### Запчасти

```yaml
Задачи:
  - Модель SparePart
  - Складской учёт
  - Модель SparePartUsage
  - Привязка к задачам ремонта

Результат:
  - Можно добавить запчасти на склад
  - При ремонте списываются запчасти
```

#### Дашборд контроля обслуживания

```yaml
Web-интерфейс:
  Общая панель:
    - Всего компонентов: 150
    - Требуют мойки СЕЙЧАС: 12 (красный)
    - Требуют мойки в течение 3 дней: 25 (жёлтый)
    - Моются сейчас: 8 (синий)
    - В норме: 105 (зелёный)

  Таблица:
    Колонки:
      - Serial Number
      - Тип
      - Подтип
      - Аппарат
      - Последняя мойка
      - Дней с мойки
      - Следующая мойка
      - Статус
      - Действия

    Фильтры:
      - По типу
      - По статусу
      - Просроченные
      - Требуют мойки сегодня

  Календарь:
    - Когда какие компоненты требуют мойки
    - Планирование

Результат:
  - Полный контроль обслуживания
  - Нет забытых компонентов
```

---

### Неделя 8: Инциденты и жалобы

#### Инциденты

```yaml
Задачи:
  - Модель Incident
  - Типы, статусы, приоритеты
  - Workflow (reported → investigating → in_progress → resolved → closed)

Автоматическое создание:
  - Расхождение при инкассации > 10% → incident
  - Задача просрочена > 48 часов → incident
  - Повторяющиеся ошибки → incident

Web-интерфейс:
  - Список инцидентов
  - Фильтры (тип, статус, машина)
  - Детали инцидента
  - Назначение ответственного
  - Решение (root cause, solution, preventive actions)

Результат:
  - Все проблемы централизованно
  - Ничего не потеряется
```

#### Клиентские жалобы (базовый)

```yaml
Задачи:
  - Модель CustomerComplaint
  - Типы, статусы, источники
  - Workflow (new → acknowledged → resolved)
  - SLA (2 часа на реакцию)

QR-код на аппарате:
  - Генерация QR для каждого аппарата
  - URL: https://vendhub.uz/complaint?m=MAC-001
  - Простая форма:
    * Тип проблемы (выбор)
    * Описание
    * Фото (опционально)
    * Контакт (опционально)

Web-интерфейс:
  - Список жалоб
  - Назначение ответственного
  - Создание задачи для решения
  - Ответ клиенту (SMS/Email/Telegram)
  - Оценка клиента (1-5 звёзд)

Результат:
  - Клиенты могут пожаловаться
  - Жалобы обрабатываются вовремя
```

**Итог недели 8**: Все важные функции реализованы

---

## Результат Фазы 2 (Important)

### Добавилось:

✅ Импорт продаж из Excel/CSV
✅ Трёхуровневая система остатков
✅ Компоненты с автоматической мойкой
✅ Запчасти
✅ Дашборд контроля обслуживания
✅ Инциденты
✅ Клиентские жалобы через QR-коды

### Система теперь:

- Контролирует все операции
- Знает где находятся товары (3 уровня)
- Автоматически планирует мойку компонентов
- Принимает жалобы от клиентов
- Управляет инцидентами
- Имеет данные о продажах

---

## Фаза 3: Advanced Features (2 месяца)

### Цель фазы
Добавить продвинутую аналитику, отчёты и автоматизацию.

### Месяц 1 (Недели 9-12): Склад и финансы

#### Склад и партии

```yaml
Задачи:
  - Модель Warehouse
  - Модель Batch (партии закупки)
  - FIFO метод списания
  - Срок годности:
    * Автоматический расчёт expiry_date
    * Алерты за X дней
    * Автоматическое списание просроченного

Результат:
  - Полноценный складской учёт
  - Контроль срока годности
```

#### Финансовые операции (расширенные)

```yaml
Задачи:
  - Все категории доходов и расходов
  - Амортизация оборудования (автоматическая):
    * Каждый месяц расчёт амортизации
    * monthly_depreciation = purchase_price / (years * 12)
    * Создание финансовой операции
  - Списание оборудования
  - Комиссии владельцам локаций

Результат:
  - Полная финансовая картина
  - Реальная рентабельность с учётом амортизации
```

#### Отчёты (часть 1)

```yaml
Отчёты:
  1. Сводный по сети (общая статистика)
  2. По аппарату (продажи, инкассации, расходы)
  3. По локации (все аппараты на локации)
  4. По товару (продажи по позиции)
  5. P&L (Profit & Loss)
  6. Cash Flow
  7. Инкассации (сводка)

Форматы:
  - Просмотр в web
  - Excel (XLSX)
  - PDF (опционально)

Результат:
  - Полная аналитика бизнеса
```

---

### Месяц 2 (Недели 13-16): Рейтинги и оптимизация

#### Рейтинг операторов (автоматический)

```yaml
Метрики:
  1. Своевременность (30%):
     - % задач в срок
     - Среднее время выполнения

  2. Качество фото (25%):
     - % задач с полными фото

  3. Точность данных (20%):
     - Расхождения при инкассации
     - Расхождения при ревизиях

  4. Отзывы клиентов (15%):
     - Средняя оценка по жалобам

  5. Дисциплина (10%):
     - Использование чек-листов
     - Отклики на сообщения

Расчёт:
  - Каждую ночь в 01:00
  - Обновление метрик
  - Уведомления операторам

Дашборд:
  - Для оператора: свой рейтинг
  - Для админа: рейтинг всех операторов

Результат:
  - Мотивация операторов
  - Понятно кто работает хорошо, кто плохо
```

#### Отчёты (часть 2)

```yaml
Отчёты:
  8. По оператору (рейтинг, задачи, эффективность)
  9. Выполнение задач (статистика по типам)
  10. Складской (остатки, движения, просрочка)
  11. Амортизация (по аппаратам)
  12. Срок годности (что истекает)
  13. Инциденты (статистика)
  14. Жалобы (статистика, NPS)

Результат:
  - Все возможные отчёты готовы
```

#### Дашборды (расширенные)

```yaml
Дашборды:
  - Главный (общая статистика)
  - Аппараты (карта, статусы, алерты)
  - Задачи (текущие, просроченные, выполненные)
  - Финансы (доходы, расходы, P&L)
  - Остатки (по уровням, алерты)
  - Инциденты и жалобы

Результат:
  - Полная картина бизнеса на одном экране
```

#### Оптимизация производительности

```yaml
Задачи:
  - Индексы на всех критичных полях
  - Материализованные представления для отчётов
  - Redis кэш для справочников
  - Оптимизация SQL запросов
  - Pagination везде
  - Lazy loading

Результат:
  - Время отклика < 200ms (p95)
  - Система работает быстро с 1000+ аппаратов
```

#### Нагрузочное тестирование

```yaml
Сценарии:
  - 100 одновременных пользователей
  - 1000 задач в день
  - 10,000 транзакций в день
  - Импорт файла на 50,000 строк

Инструменты:
  - k6 / Locust / JMeter

Результат:
  - Система выдерживает нагрузку
  - Определены узкие места
```

**Итог месяца 2**: Production-ready система!

---

## Результат Фазы 3 (Advanced)

### Добавилось:

✅ Склад с партиями (FIFO)
✅ Контроль срока годности
✅ Амортизация оборудования
✅ Рейтинг операторов
✅ Все отчёты (14 видов)
✅ Расширенные дашборды
✅ Оптимизированная производительность

### Система готова к:

- Масштабированию до 1000+ аппаратов
- Работе с 100+ операторами
- Обработке 1M+ транзакций в месяц

---

## Фаза 4: Интеграция (будущее)

### Когда появится возможность подключения к аппаратам

#### Модуль интеграции

```yaml
Задачи:
  - API для получения данных от аппаратов
  - Connectivity Status (online/offline)
  - Коды ошибок (автоматические задачи ремонта)
  - Показания счётчиков
  - Уровни ингредиентов
  - Температура, давление
  - Управление настройками

Подход:
  - Постепенная интеграция (по 1-2 аппаратам)
  - Hybrid режим (часть с интеграцией, часть без)
  - Фото-контроль остаётся как дополнение

Результат:
  - Ещё больше автоматизации
  - Ещё меньше ручного труда
  - Система уже работала БЕЗ интеграции, интеграция - бонус
```

---

## Критерии готовности

### MVP (Фаза 1):
- ✅ Операторы могут выполнять задачи через Telegram
- ✅ Админы видят выполнение задач в web-панели
- ✅ Фото-отчёты работают
- ✅ Инкассации фиксируются
- ✅ Остатки обновляются

### Important (Фаза 2):
- ✅ Продажи импортируются
- ✅ Трёхуровневые остатки работают
- ✅ Компоненты моются автоматически
- ✅ Жалобы обрабатываются

### Advanced (Фаза 3):
- ✅ Все отчёты работают
- ✅ Рейтинг операторов рассчитывается
- ✅ Система быстрая (< 200ms)
- ✅ Можно масштабироваться

---

## Команда и роли

### Минимальная команда:

**Backend (1-2 разработчика):**
- Node.js/Python
- PostgreSQL
- API

**Frontend (1 разработчик):**
- Next.js
- React

**Mobile/Bot (1 разработчик):**
- Telegram Bot API
- Python/Node.js

**DevOps (0.5 позиции):**
- Docker
- CI/CD
- Мониторинг

**QA (0.5 позиции):**
- Ручное тестирование
- E2E тесты

**Итого: 3-4 разработчика full-time**

---

## Риски и митигация

### Риск 1: Операторы не будут делать фото

**Митигация:**
- Жёсткая валидация (нельзя закрыть без фото)
- Проверка GPS координат
- Штрафы за нарушения
- Обучение

### Риск 2: Долго загружать продажи

**Митигация:**
- Автоматизация загрузки (скрипты)
- API для автоматического импорта
- Обучение админов

### Риск 3: Расхождения в остатках

**Митигация:**
- Регулярные ревизии
- Автоматические алерты
- Рейтинг операторов (штраф за неточность)

### Риск 4: Производительность при масштабировании

**Митигация:**
- Партиционирование (transactions, audit_logs)
- Индексы
- Redis кэш
- Оптимизация запросов
- Нагрузочное тестирование

---

## Итого

**Roadmap на 12 недель:**
- ✅ Фаза 1 (4 недели) - MVP
- ✅ Фаза 2 (4 недели) - Important
- ✅ Фаза 3 (4 недели) - Advanced

**Результат:**
Production-ready система для управления 31+ аппаратами БЕЗ необходимости прямой интеграции.

**Дальше:**
- Масштабирование до 100+ аппаратов
- Добавление интеграции с аппаратами (когда появится возможность)
- Мобильное приложение (опционально)
- CRM интеграция
- BI системы

**Начинаем с MVP!**
