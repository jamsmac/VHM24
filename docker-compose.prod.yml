version: '3.8'

# ============================================================================
# VendHub Manager - Production Docker Compose
# ============================================================================
# This configuration includes:
# - Backend API (NestJS)
# - Frontend (Next.js)
# - BullMQ Workers (Commission, Job Scheduler, Health Monitor)
# - PostgreSQL Database
# - Redis (BullMQ Queue)
# - MinIO (S3-compatible storage)
# - Prometheus (Metrics)
# - Grafana (Monitoring Dashboard)
# - Nginx (Reverse Proxy)
# ============================================================================

networks:
  vendhub-network:
    driver: bridge
  monitoring-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  minio-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  nginx-logs:
    driver: local

services:
  # ==========================================================================
  # DATABASE - PostgreSQL
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: vendhub-postgres
    restart: always
    environment:
      POSTGRES_DB: ${DATABASE_NAME:-vendhub}
      POSTGRES_USER: ${DATABASE_USER:-vendhub}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=en_US.UTF-8"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backend/database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - vendhub-network
    ports:
      - "127.0.0.1:5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER:-vendhub}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # CACHE & QUEUE - Redis
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: vendhub-redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
    volumes:
      - redis-data:/data
    networks:
      - vendhub-network
    ports:
      - "127.0.0.1:6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # STORAGE - MinIO (S3-compatible)
  # ==========================================================================
  minio:
    image: minio/minio:latest
    container_name: vendhub-minio
    restart: always
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:?S3_ACCESS_KEY required}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:?S3_SECRET_KEY required}
      MINIO_BROWSER: "on"
      MINIO_PROMETHEUS_AUTH_TYPE: "public"
    volumes:
      - minio-data:/data
    networks:
      - vendhub-network
      - monitoring-network
    ports:
      - "127.0.0.1:9000:9000"
      - "127.0.0.1:9001:9001"
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # BACKEND API - NestJS
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    image: vendhub-backend:${VERSION:-latest}
    container_name: vendhub-backend
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-vendhub}
      DATABASE_USER: ${DATABASE_USER:-vendhub}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required}
      JWT_ACCESS_EXPIRATION: ${JWT_ACCESS_EXPIRATION:-15m}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-7d}
      
      # S3 Storage
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: ${S3_BUCKET:-vendhub}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:?S3_ACCESS_KEY required}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY required}
      S3_REGION: ${S3_REGION:-us-east-1}
      
      # Telegram Bot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:?TELEGRAM_BOT_TOKEN required}
      
      # Frontend URL for CORS
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      
      # Monitoring
      METRICS_ENABLED: "true"
    networks:
      - vendhub-network
      - monitoring-network
    ports:
      - "127.0.0.1:3000:3000"
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health/live', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ==========================================================================
  # WORKER - Commission Calculator
  # ==========================================================================
  commission-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    image: vendhub-backend:${VERSION:-latest}
    container_name: vendhub-commission-worker
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      WORKER_NAME: commission-worker
      
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-vendhub}
      DATABASE_USER: ${DATABASE_USER:-vendhub}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      
      # JWT (needed for context)
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required}
      
      # Worker config
      WORKER_CONCURRENCY: ${COMMISSION_WORKER_CONCURRENCY:-2}
      
      # Monitoring
      METRICS_ENABLED: "true"
    command: ["node", "dist/workers/commission.worker.js"]
    networks:
      - vendhub-network
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # ==========================================================================
  # WORKER - Job Scheduler
  # ==========================================================================
  job-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    image: vendhub-backend:${VERSION:-latest}
    container_name: vendhub-job-scheduler
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      WORKER_NAME: job-scheduler
      
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-vendhub}
      DATABASE_USER: ${DATABASE_USER:-vendhub}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required}
      
      # Timezone
      TZ: Asia/Tashkent
      
      # Monitoring
      METRICS_ENABLED: "true"
    command: ["node", "dist/workers/job-scheduler.worker.js"]
    networks:
      - vendhub-network
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # WORKER - Health Monitor
  # ==========================================================================
  health-monitor:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    image: vendhub-backend:${VERSION:-latest}
    container_name: vendhub-health-monitor
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      WORKER_NAME: health-monitor
      
      # Database
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: ${DATABASE_NAME:-vendhub}
      DATABASE_USER: ${DATABASE_USER:-vendhub}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD required}
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:?REDIS_PASSWORD required}
      
      # JWT
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required}
      
      # Monitoring
      METRICS_ENABLED: "true"
    command: ["node", "dist/workers/health-monitor.worker.js"]
    networks:
      - vendhub-network
      - monitoring-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # FRONTEND - Next.js
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost/api/v1}
        NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-http://localhost}
    image: vendhub-frontend:${VERSION:-latest}
    container_name: vendhub-frontend
    restart: always
    depends_on:
      backend:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost/api/v1}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL:-http://localhost}
    networks:
      - vendhub-network
    ports:
      - "127.0.0.1:3001:3000"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # MONITORING - Prometheus
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: vendhub-prometheus
    restart: always
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    networks:
      - monitoring-network
    ports:
      - "127.0.0.1:9090:9090"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # MONITORING - Grafana
  # ==========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: vendhub-grafana
    restart: always
    depends_on:
      prometheus:
        condition: service_healthy
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD required}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: ${GRAFANA_ROOT_URL:-http://localhost/grafana}
      GF_INSTALL_PLUGINS: "redis-datasource"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    networks:
      - monitoring-network
    ports:
      - "127.0.0.1:3002:3000"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==========================================================================
  # REVERSE PROXY - Nginx
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: vendhub-nginx
    restart: always
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
      grafana:
        condition: service_healthy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    networks:
      - vendhub-network
      - monitoring-network
    ports:
      - "80:80"
      - "443:443"
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
