#===============================================================================
# VendHub PostgreSQL Production Configuration
#===============================================================================
#
# This configuration optimizes PostgreSQL for VendHub production deployment
# with focus on:
# - Performance (connection pooling, query optimization, caching)
# - Reliability (WAL archiving, replication, checksums)
# - Monitoring (logging, statistics, performance tracking)
#
# Apply settings:
#   1. Copy to PostgreSQL data directory: /var/lib/postgresql/data/postgresql.conf
#   2. Restart PostgreSQL: sudo systemctl restart postgresql
#   3. Verify: SELECT name, setting FROM pg_settings WHERE name LIKE '%wal%';
#
# Adjust based on your server resources:
# - shared_buffers: 25% of RAM
# - effective_cache_size: 50-75% of RAM
# - maintenance_work_mem: 5% of RAM (max 2GB)
#===============================================================================

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Maximum number of concurrent connections
# Recommended: Use connection pooling (PgBouncer) to reduce this
max_connections = 100

# Security
ssl = on
ssl_cert_file = '/etc/ssl/certs/postgresql.crt'
ssl_key_file = '/etc/ssl/private/postgresql.key'

# Password encryption
password_encryption = scram-sha-256

#------------------------------------------------------------------------------
# MEMORY SETTINGS
#------------------------------------------------------------------------------

# Shared memory for PostgreSQL (25% of RAM)
# For 8GB RAM: 2GB
# For 16GB RAM: 4GB
shared_buffers = 2GB

# Memory for sorting, hash tables (per operation)
# Start with 4MB and monitor
work_mem = 16MB

# Memory for maintenance operations (VACUUM, CREATE INDEX)
# 5% of RAM, max 2GB
maintenance_work_mem = 512MB

# Planner's estimate of OS cache (50-75% of RAM)
effective_cache_size = 6GB

# Memory for WAL buffers (auto-tuned if -1)
wal_buffers = -1

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG (WAL)
#------------------------------------------------------------------------------

# WAL level for replication and PITR
# Options: minimal, replica, logical
wal_level = replica

# Synchronous commit (tradeoff: durability vs performance)
# Options: on, remote_apply, remote_write, local, off
# Production: on (default) for maximum durability
synchronous_commit = on

# Full page writes (required for crash safety)
full_page_writes = on

# WAL file size (16MB is default)
wal_segment_size = 16MB

# Minimum WAL segments to keep
min_wal_size = 1GB
max_wal_size = 4GB

# Checkpoint settings
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
checkpoint_warning = 30s

#------------------------------------------------------------------------------
# WAL ARCHIVING (for Point-in-Time Recovery)
#------------------------------------------------------------------------------

# Enable WAL archiving
archive_mode = on

# Archive command - customize based on your backup strategy
# Option 1: Local directory
archive_command = 'test ! -f /mnt/wal_archive/%f && cp %p /mnt/wal_archive/%f'

# Option 2: S3 (requires AWS CLI)
# archive_command = 'aws s3 cp %p s3://vendhub-wal-archive/%f'

# Option 3: Multiple destinations (local + S3)
# archive_command = 'test ! -f /mnt/wal_archive/%f && cp %p /mnt/wal_archive/%f && aws s3 cp %p s3://vendhub-wal-archive/%f'

# Force WAL switch after timeout (5 minutes)
archive_timeout = 300

#------------------------------------------------------------------------------
# REPLICATION (for standby servers)
#------------------------------------------------------------------------------

# Maximum number of concurrent WAL sender processes
max_wal_senders = 3

# Standby servers that should be kept
wal_keep_size = 1GB

# Hot standby for read replicas
hot_standby = on
hot_standby_feedback = on

# Replication timeout
wal_sender_timeout = 60s

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

# Enable parallel query execution
max_parallel_workers_per_gather = 2
max_parallel_workers = 8
max_worker_processes = 8

# Random page cost (SSD: 1.1, HDD: 4.0)
random_page_cost = 1.1

# Effective I/O concurrency (SSD: 200, HDD: 2)
effective_io_concurrency = 200

# Query planner settings
default_statistics_target = 100
constraint_exclusion = partition

#------------------------------------------------------------------------------
# AUTOVACUUM (automatic maintenance)
#------------------------------------------------------------------------------

# Enable autovacuum
autovacuum = on

# Autovacuum workers
autovacuum_max_workers = 3

# Thresholds for triggering autovacuum
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# Autovacuum cost delay (0 = no delay)
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 200

#------------------------------------------------------------------------------
# LOGGING
#------------------------------------------------------------------------------

# Where to log
logging_collector = on
log_directory = '/var/log/postgresql'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB

# What to log
log_min_duration_statement = 1000  # Log slow queries (>1s)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'none'  # Don't log all statements
log_duration = off      # Don't log all durations
log_min_messages = warning

# Log checkpoints
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on

# Log autovacuum
log_autovacuum_min_duration = 1000  # Log autovacuum >1s

# Log errors
log_error_verbosity = default

#------------------------------------------------------------------------------
# STATISTICS & MONITORING
#------------------------------------------------------------------------------

# Track query execution statistics
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.save = on

# Statistics collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all

# Update statistics target
stats_temp_directory = '/var/run/postgresql/stats_temp'

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement timeout (prevent long-running queries)
# 0 = disabled, or set in seconds
statement_timeout = 0  # Adjust based on your needs

# Lock timeout
lock_timeout = 0  # Adjust based on your needs

# Idle in transaction session timeout
idle_in_transaction_session_timeout = 10min

# Time zone
timezone = 'UTC'

# Locale settings
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# DATA CHECKSUMS & INTEGRITY
#------------------------------------------------------------------------------

# Data checksums (enable at initdb with --data-checksums)
# Can't be changed after cluster creation
# data_checksums = on

# Full page writes (required for crash safety)
full_page_writes = on

# Write ahead log sync method
# Options: fsync, fdatasync, open_sync
wal_sync_method = fdatasync

# Commit delay (microseconds, 0 = disabled)
commit_delay = 0
commit_siblings = 5

#------------------------------------------------------------------------------
# RESOURCE USAGE (ASYNCHRONOUS BEHAVIOR)
#------------------------------------------------------------------------------

# Background writer settings
bgwriter_delay = 200ms
bgwriter_lru_maxpages = 100
bgwriter_lru_multiplier = 2.0

# Asynchronous commit (off for durability)
synchronous_commit = on

#------------------------------------------------------------------------------
# LOCK MANAGEMENT
#------------------------------------------------------------------------------

# Maximum number of locks per transaction
max_locks_per_transaction = 64

# Deadlock timeout
deadlock_timeout = 1s

#------------------------------------------------------------------------------
# VERSION/PLATFORM COMPATIBILITY
#------------------------------------------------------------------------------

# Prevent modification by non-superusers
allow_system_table_mods = off

# Escape string warning
escape_string_warning = on
standard_conforming_strings = on

#===============================================================================
# PERFORMANCE TUNING NOTES
#===============================================================================
#
# 1. Monitor with:
#    SELECT * FROM v_database_summary;
#    SELECT * FROM v_slow_queries LIMIT 20;
#
# 2. Check cache hit ratio (should be >95%):
#    SELECT * FROM v_cache_hit_ratio;
#
# 3. Monitor WAL archiving:
#    SELECT archived_count, failed_count FROM pg_stat_archiver;
#
# 4. Check replication lag (if using replicas):
#    SELECT * FROM pg_stat_replication;
#
# 5. Adjust based on workload:
#    - OLTP (many short queries): Lower work_mem, higher shared_buffers
#    - Analytics (few long queries): Higher work_mem, parallel workers
#
#===============================================================================
