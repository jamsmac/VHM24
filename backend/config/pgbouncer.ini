;;;===============================================================================
;;; VendHub PgBouncer Configuration
;;;===============================================================================
;;;
;;; PgBouncer is a PostgreSQL connection pooler that:
;;; - Reduces connection overhead (each connection = ~10MB memory)
;;; - Handles connection spikes gracefully
;;; - Limits connections to PostgreSQL server
;;; - Improves application performance
;;;
;;; Installation:
;;;   Ubuntu/Debian: sudo apt install pgbouncer
;;;   CentOS/RHEL:   sudo yum install pgbouncer
;;;   macOS:         brew install pgbouncer
;;;
;;; Setup:
;;;   1. Copy this file to /etc/pgbouncer/pgbouncer.ini
;;;   2. Create userlist.txt with user credentials
;;;   3. Adjust DATABASE_URL in app to point to PgBouncer
;;;   4. Start: sudo systemctl start pgbouncer
;;;
;;; Application Connection String Changes:
;;;   Before: postgresql://user:pass@localhost:5432/vendhub
;;;   After:  postgresql://user:pass@localhost:6432/vendhub
;;;
;;;===============================================================================

[databases]

;;; Database connection definitions
;;; Format: dbname = host=... port=... dbname=...

;; Production database
vendhub = host=localhost port=5432 dbname=vendhub

;; Test database (optional)
;vendhub_test = host=localhost port=5432 dbname=vendhub_test

;; You can also use connection strings:
;vendhub = postgresql://postgres@localhost:5432/vendhub

;;;===============================================================================
;;; [pgbouncer] - Core Configuration
;;;===============================================================================

[pgbouncer]

;;;-----------------------------------------------------------------------------
;;; Administrative Settings
;;;-----------------------------------------------------------------------------

;; Listen address and port
;; PgBouncer listens on this port, PostgreSQL on 5432
listen_addr = 0.0.0.0
listen_port = 6432

;; Unix socket (optional, for local connections)
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777

;;;-----------------------------------------------------------------------------
;;; Authentication
;;;-----------------------------------------------------------------------------

;; Authentication file with usernames and passwords
;; Format: "username" "password"
;; Generate with: echo "\"$USER\" \"md5$(echo -n "${PASS}${USER}" | md5sum | cut -d' ' -f1)\""
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; Optional: Use PostgreSQL's pg_shadow for authentication
;; Requires: auth_user and auth_query
;auth_type = hba
;auth_hba_file = /etc/pgbouncer/pg_hba.conf

;;;-----------------------------------------------------------------------------
;;; Pool Mode
;;;-----------------------------------------------------------------------------

;; Pool mode determines when connections are reused:
;;
;; session:      Client connection = server connection (most compatible)
;;               Use when: application uses prepared statements, advisory locks, LISTEN/NOTIFY
;;               Good for: compatibility
;;
;; transaction:  Connection returned to pool after each transaction (recommended)
;;               Use when: standard web applications, REST APIs
;;               Good for: most use cases, balances compatibility and pooling
;;
;; statement:    Connection returned after each statement (aggressive pooling)
;;               Use when: simple queries only, no transactions
;;               Good for: maximum pooling, but limited compatibility

pool_mode = transaction

;;;-----------------------------------------------------------------------------
;;; Connection Limits
;;;-----------------------------------------------------------------------------

;; Maximum connections PgBouncer accepts from clients
max_client_conn = 1000

;; Maximum connections PgBouncer opens to PostgreSQL
;; This should match or be less than PostgreSQL's max_connections
;; PostgreSQL default: 100
default_pool_size = 25

;; Minimum pool size (keep connections warm)
min_pool_size = 10

;; Additional connections for emergencies
reserve_pool_size = 5

;; How many additional connections can be made in reserve pool timeout
reserve_pool_timeout = 3

;; Maximum connections per database
max_db_connections = 50

;; Maximum connections per user
max_user_connections = 50

;;;-----------------------------------------------------------------------------
;;; Server Connection Settings
;;;-----------------------------------------------------------------------------

;; Server lifetime: Close server connection after this many seconds
;; 0 = unlimited, recommended: 3600 (1 hour)
server_lifetime = 3600

;; Server idle timeout: Close connection if idle for this many seconds
;; Recommended: 600 (10 minutes)
server_idle_timeout = 600

;; Server connect timeout
server_connect_timeout = 15

;; How long to wait for query results before timing out
query_timeout = 0

;; How long to wait before cancelling query on server
query_wait_timeout = 120

;;;-----------------------------------------------------------------------------
;;; Client Connection Settings
;;;-----------------------------------------------------------------------------

;; Client idle timeout
;; Disconnect client if idle for this many seconds
client_idle_timeout = 0

;; Client login timeout
client_login_timeout = 60

;;;-----------------------------------------------------------------------------
;;; Timeouts
;;;-----------------------------------------------------------------------------

;; How long to wait when the pool is full
;; 0 = reject immediately
autodb_idle_timeout = 3600

;; Close connections that have been idle this many seconds in transaction
;; Good for: preventing stuck transactions from holding connections
idle_transaction_timeout = 0

;;;-----------------------------------------------------------------------------
;;; TLS/SSL Settings
;;;-----------------------------------------------------------------------------

;; Enable TLS/SSL
;client_tls_sslmode = prefer
;client_tls_ca_file = /etc/ssl/certs/ca.crt
;client_tls_cert_file = /etc/ssl/certs/pgbouncer.crt
;client_tls_key_file = /etc/ssl/private/pgbouncer.key

;; Server TLS (to PostgreSQL)
;server_tls_sslmode = prefer

;;;-----------------------------------------------------------------------------
;;; Logging
;;;-----------------------------------------------------------------------------

;; Log file location
logfile = /var/log/postgresql/pgbouncer.log

;; Log connections
log_connections = 1

;; Log disconnections
log_disconnections = 1

;; Log pooler errors
log_pooler_errors = 1

;; Syslog integration (optional)
;syslog = 1
;syslog_ident = pgbouncer
;syslog_facility = daemon

;; Verbose logging (0-2)
;; 0 = normal, 1 = verbose, 2 = debug
verbose = 0

;;;-----------------------------------------------------------------------------
;;; Administrative Access
;;;-----------------------------------------------------------------------------

;; Administrative database (for SHOW commands)
;; Connect with: psql -p 6432 -U $USER pgbouncer
admin_users = postgres

;; Statistics users (read-only access to stats)
stats_users = postgres

;;;-----------------------------------------------------------------------------
;;; Advanced Settings
;;;-----------------------------------------------------------------------------

;; Application name to send to PostgreSQL
;application_name_add_host = 1

;; Disable pqExec() mechanism
;disable_pqexec = 0

;; DNS cache time
;dns_max_ttl = 15

;; DNS lookup frequency
;dns_zone_check_period = 0

;; Maximum packet size
;pkt_buf = 4096

;; Maximum packet count per buffer
;sbuf_loopcnt = 5

;; TCP socket options
so_reuseport = 1
tcp_keepalive = 1
tcp_keepidle = 60
tcp_keepintvl = 10
tcp_keepcnt = 5

;; TCP user timeout
tcp_user_timeout = 0

;;;===============================================================================
;;; Configuration Notes
;;;===============================================================================
;;;
;;; 1. SIZING GUIDELINES:
;;;    - max_client_conn: Expected concurrent connections from app (e.g., 1000)
;;;    - default_pool_size: Active connections to PostgreSQL (e.g., 25)
;;;    - Ratio: With 1000 clients and 25 pool size, ratio is 40:1
;;;    - Rule of thumb: Start with 20-30 connections per CPU core
;;;
;;; 2. POOL MODE SELECTION:
;;;    - Use 'transaction' for most web applications (NestJS, Express, etc.)
;;;    - Use 'session' if you need:
;;;      - Prepared statements across transactions
;;;      - Advisory locks
;;;      - LISTEN/NOTIFY
;;;      - Temporary tables
;;;    - Use 'statement' only for simple read-only queries
;;;
;;; 3. MONITORING:
;;;    - Connect to admin: psql -p 6432 pgbouncer
;;;    - Show pools: SHOW POOLS;
;;;    - Show stats: SHOW STATS;
;;;    - Show clients: SHOW CLIENTS;
;;;    - Show servers: SHOW SERVERS;
;;;    - Reload config: RELOAD;
;;;
;;; 4. SECURITY:
;;;    - Use md5 or scram-sha-256 authentication
;;;    - Restrict admin_users to trusted accounts
;;;    - Use TLS/SSL in production
;;;    - Set proper file permissions: chmod 600 /etc/pgbouncer/*
;;;
;;; 5. PERFORMANCE TUNING:
;;;    - If seeing connection timeouts, increase default_pool_size
;;;    - If PostgreSQL shows high connection count, reduce default_pool_size
;;;    - Monitor with: SELECT * FROM pg_stat_activity;
;;;    - Target: <50% of PostgreSQL max_connections used
;;;
;;; 6. COMMON ISSUES:
;;;    - "no more connections allowed": Increase max_client_conn
;;;    - "query timeout": Increase query_wait_timeout
;;;    - "server login failed": Check userlist.txt and PostgreSQL auth
;;;    - High latency: Check pool_mode, may need 'session'
;;;
;;;===============================================================================
