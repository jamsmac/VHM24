name: Deploy to Production

on:
  push:
    branches: [main]
    # Only deploy on version tags
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true

env:
  NODE_VERSION: '20'

jobs:
  # Validate manual deployment confirmation
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "Deployment not confirmed. Please type 'deploy' to confirm."
            exit 1
          fi
          echo "Production deployment confirmed!"

  # Run full CI checks
  ci-check:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  # Deploy to production after CI passes
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [ci-check]
    if: |
      always() &&
      needs.ci-check.result == 'success' &&
      (github.event_name != 'workflow_dispatch' || needs.validate.result == 'success')
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci --production

      - name: Build backend
        working-directory: ./backend
        run: npm run build

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.PRODUCTION_API_URL }}
        run: npm run build

      # Database migration (with backup)
      - name: Run database migrations
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.PRODUCTION_DATABASE_URL }}
          DATABASE_HOST: ${{ secrets.PRODUCTION_DATABASE_HOST }}
          DATABASE_PORT: ${{ secrets.PRODUCTION_DATABASE_PORT }}
          DATABASE_NAME: ${{ secrets.PRODUCTION_DATABASE_NAME }}
          DATABASE_USER: ${{ secrets.PRODUCTION_DATABASE_USER }}
          DATABASE_PASSWORD: ${{ secrets.PRODUCTION_DATABASE_PASSWORD }}
        run: |
          echo "Creating database backup before migration..."
          # Backup will be handled by deployment platform or external tool
          echo "Running migrations..."
          npm run migration:run
          if [ $? -ne 0 ]; then
            echo "::error::Migration failed! Deployment aborted."
            exit 1
          fi
          echo "Migrations completed successfully"

      # Placeholder for actual deployment steps
      - name: Deployment placeholder
        run: |
          echo "=========================================="
          echo "Production deployment workflow triggered"
          echo "=========================================="
          echo ""
          echo "Trigger: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo ""
          echo "To complete this workflow, configure:"
          echo "1. Add production secrets to GitHub repository"
          echo "2. Set up 'production' environment with protection rules"
          echo "3. Configure deployment steps for your provider"
          echo ""
          echo "Recommended protection rules for 'production' environment:"
          echo "- Required reviewers: 1+"
          echo "- Wait timer: 5 minutes"
          echo "- Deployment branches: main, v*"
          echo "=========================================="

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify deployment
        if: success()
        run: |
          echo "Production deployment completed successfully!"
          # Add Slack/Discord/PagerDuty notification here
